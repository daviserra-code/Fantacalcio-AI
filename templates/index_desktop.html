<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FantacalcioAI ‚Äì Aste, Consigli, Roster</title>
  <link rel="icon" type="image/svg+xml" href="/static/assets/favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="/static/styles/fantacalcioai.css">
  <meta name="theme-color" content="#0A84FF">
  <style>
    /* Light and Dark Theme Variables */
    :root {
      --bg-color: #ffffff;
      --text-color: #1f2937;
      --header-bg: #f8f9fa;
      --card-bg: #ffffff;
      --primary-btn-bg: linear-gradient(135deg, #667eea, #764ba2);
      --primary-btn-text: white;
      --secondary-btn-bg: #f3f4f6;
      --secondary-btn-text: #374151;
      --input-border: #d1d5db;
      --table-header-bg: #f9fafb;
      --table-text: #374151;
      --chat-message-user-bg: #667eea;
      --chat-message-assistant-bg: #f9fafb;
      --error-bg: #fef2f2;
      --error-text: #dc2626;
      --table-row-bg: #f9fafb;
      --table-alt-bg: #f3f4f6;
      --comparison-header-bg: #f3f4f6;
      --comparison-player1-color: #2563eb;
      --comparison-player2-color: #dc2626;
      --fcai-primary: #667eea;
      --fcai-text: #1f2937;
      --fcai-text-dim: #6b7280;
      --fcai-border: #e5e7eb;
      --fcai-surface: #ffffff;
      --fcai-elev: #f9fafb;
    }

    .dark-theme {
      --bg-color: #0f172a;
      --text-color: #f1f5f9;
      --header-bg: #1e293b;
      --card-bg: #1e293b;
      --primary-btn-bg: linear-gradient(135deg, #8a8aff, #a074c4);
      --primary-btn-text: white;
      --secondary-btn-bg: #374151;
      --secondary-btn-text: #f3f4f6;
      --input-border: #4b5563;
      --table-header-bg: #374151;
      --table-text: #f3f4f6;
      --chat-message-user-bg: #8a8aff;
      --chat-message-assistant-bg: #374151;
      --error-bg: #1f2937;
      --error-text: #fca5a5;
      --table-row-bg: #1e293b;
      --table-alt-bg: #334155;
      --comparison-header-bg: #334155;
      --comparison-player1-color: #60a5fa;
      --comparison-player2-color: #f87171;
      --fcai-primary: #8a8aff;
      --fcai-text: #f1f5f9;
      --fcai-text-dim: #cbd5e1;
      --fcai-border: #475569;
      --fcai-surface: #1e293b;
      --fcai-elev: #334155;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }

    .header {
      background-color: var(--header-bg);
      transition: background-color 0.3s;
    }

    .card {
      background-color: var(--card-bg);
      transition: background-color 0.3s;
    }

    .btn.primary {
      background: var(--primary-btn-bg);
      color: var(--primary-btn-text);
    }

    .btn.ghost {
      background: var(--secondary-btn-bg);
      color: var(--secondary-btn-text);
      border: 1px solid var(--secondary-btn-text);
    }

    .btn.cta, .btn.primary {
        background: var(--primary-btn-bg);
        color: var(--primary-btn-text);
    }

    .btn.ghost {
        background: var(--secondary-btn-bg);
        color: var(--secondary-btn-text);
        border: 1px solid var(--secondary-btn-text);
    }

    input, select, textarea {
      border: 1px solid var(--input-border);
      background-color: var(--card-bg);
      color: var(--text-color);
    }
    input:focus, select:focus, textarea:focus {
        border-color: var(--fcai-primary); /* Assuming --fcai-primary is defined elsewhere or default blue */
        outline: none;
    }

    .table th {
      background-color: var(--table-header-bg);
      color: var(--table-text);
    }

    .chat-container .chat-header {
      background: var(--header-bg);
      border-bottom: 1px solid var(--input-border);
    }

    .chat-container .chat-header span {
      color: var(--text-color);
      opacity: 0.8;
    }

    #desktopChatMessages div {
      background: var(--chat-message-assistant-bg);
      color: var(--text-color);
    }

    #desktopChatMessages .user-message { /* Custom class for user messages */
      background: var(--chat-message-user-bg);
      color: var(--primary-btn-text);
    }

    #desktopTypingIndicator {
      background: var(--chat-message-assistant-bg);
      color: var(--text-color);
    }

    #searchInput, #desktopMessageInput {
        background-color: var(--card-bg);
        color: var(--text-color);
        border: 1px solid var(--input-border);
    }

    .quick-action-btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 16px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        min-height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
    }

    .quick-action-btn:hover {
        background: linear-gradient(135deg, #5a67d8, #6b46c1);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .quick-action-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
    }

    .footer {
        background-color: var(--header-bg);
        color: var(--text-color);
        transition: background-color 0.3s;
    }

    /* Spinner animation for analytics loading */
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Adjustments for selected div alignment */
    .hero .container > div:first-child {
        margin-top: 0; /* Reset default top margin */
    }
    .hero .container > div {
        margin-top: 40px; /* Move content higher */
    }
    .hero .container {
        display: flex;
        align-items: flex-start; /* Align items to the top */
        gap: 32px; /* Space between content and card */
    }
    .hero .card.pad {
        margin-top: 0; /* Align card to the top */
        margin-left: auto; /* Push to the right if needed, or remove for left align */
        /* If it needs to align with the table, the table's parent might need adjustment */
    }

    /* Responsive adjustments for hero section */
    @media (max-width: 768px) {
        .hero .container {
            flex-direction: column;
            align-items: center; /* Center items when stacked */
        }
        .hero .card.pad {
            margin-top: 24px; /* Add some space when stacked */
            margin-left: 0;
            width: 100%;
        }
        .hero .container > div {
            margin-top: 0; /* Reset margin when stacked */
        }
    }

    /* Light Theme Specific Adjustments */
    body { 
        color: var(--text-color); 
        background-color: var(--bg-color);
    }
    
    .container { 
        color: var(--text-color); 
    }

    /* Chat messages styling for both themes */
    .assistant-message { 
        background: var(--chat-message-assistant-bg); 
        color: var(--text-color); 
        border: 1px solid var(--input-border);
    }
    
    .typing-indicator { 
        background: var(--chat-message-assistant-bg); 
        color: var(--text-color); 
    }
    
    .player-card { 
        background: var(--card-bg); 
        border-color: var(--input-border); 
        color: var(--text-color); 
    }

    /* Component styling for both themes */
    .kicker { 
        background: var(--fcai-elev); 
        border-color: var(--input-border); 
        color: var(--text-color); 
    }
    
    .kpi { 
        background: var(--card-bg); 
        border-color: var(--input-border); 
        color: var(--text-color); 
    }
    
    /* Standardized quick action buttons */
    .quick-action-btn { 
        background: var(--primary-btn-bg) !important;
        color: var(--primary-btn-text) !important; 
        border: none !important;
        padding: 14px 18px !important;
        border-radius: 12px !important;
        font-size: 14px !important;
        font-weight: 600 !important;
        cursor: pointer !important;
        min-height: 55px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        text-align: center !important;
        box-shadow: 0 3px 10px rgba(102, 126, 234, 0.4) !important;
        transition: all 0.3s ease !important;
        opacity: 1 !important;
        visibility: visible !important;
    }
    .quick-action-btn:hover { 
        background: linear-gradient(135deg, #5a67d8, #6b46c1) !important;
        color: white !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4) !important;
    }
    
    /* Table styling */
    .table { 
        color: var(--text-color); 
        background-color: var(--card-bg);
    }
    .table th { 
        background-color: var(--table-header-bg); 
        color: var(--table-text); 
    }
    .table td { 
        border-bottom-color: var(--input-border); 
        color: var(--text-color);
    }
    .help { 
        color: var(--fcai-text-dim); 
    }

    /* Navigation and layout */
    .nav a { 
        color: var(--text-color); 
    }
    .nav .brand .word { 
        color: var(--fcai-text); 
    }
    .lead { 
        color: var(--fcai-text-dim); 
    }
    .section { 
        background-color: var(--bg-color); 
        color: var(--text-color);
    }
    .section.alt { 
        background-color: var(--fcai-elev); 
    }
    
    /* Chat container */
    .chat-container { 
        background-color: var(--card-bg); 
        border-color: var(--input-border); 
        color: var(--text-color);
    }
    .chat-header { 
        background-color: var(--header-bg); 
        color: var(--text-color); 
        border-color: var(--input-border); 
    }
    #desktopChatMessages div { 
        background: var(--chat-message-assistant-bg); 
        color: var(--text-color); 
        border-color: var(--input-border); 
    }
    #desktopTypingIndicator { 
        background: var(--chat-message-assistant-bg); 
        color: var(--text-color); 
    }
    
    /* Typography */
    h1, h2, h3, h4, h5, h6 { 
        color: var(--text-color); 
    }
    
    /* Footer */
    .footer { 
        background-color: var(--header-bg); 
        color: var(--fcai-text-dim); 
    }
    
    /* Buttons */
    .btn { 
        background-color: var(--secondary-btn-bg); 
        color: var(--secondary-btn-text); 
        border-color: var(--input-border); 
    }
    .btn:hover { 
        filter: brightness(0.95); 
    }
    .btn.primary { 
        background: var(--primary-btn-bg); 
        color: var(--primary-btn-text); 
        border-color: transparent; 
    }
    .btn.ghost { 
        background: transparent; 
        color: var(--text-color); 
        border-color: var(--input-border); 
    }
    
    /* Cards and containers */
    .grid-2 .card { 
        border-color: var(--input-border); 
        background-color: var(--card-bg);
        color: var(--text-color);
    }
    .toolbar { 
        background-color: var(--card-bg); 
        border-color: var(--input-border); 
    }
    
    /* Form elements */
    input, select, textarea { 
        background-color: var(--card-bg); 
        color: var(--text-color); 
        border-color: var(--input-border); 
    }
    input:focus, select:focus, textarea:focus { 
        border-color: var(--fcai-primary); 
    }

  </style>
</head>
<body>
  <header class="header">
    <div class="container nav">
      <a class="brand" href="/">
        <svg width="280" height="68" viewBox="0 0 280 48" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-labelledby="title desc">
          <title id="title">FantacalcioAI - Logo</title>
          <desc id="desc">Wordmark con monogramma a scudo, pallone e nodi AI orbitanti</desc>
          <g transform="translate(4,4)">
            <path d="M20 0 L38 6 C38 20 31 31 20 40 C9 31 2 20 2 6 L20 0Z" fill="#0A84FF"/>
            <circle cx="20" cy="18" r="9" fill="white"/>
            <polygon points="20,11 24,14 23,19 17,19 16,14" fill="#0A84FF"/>
            <circle cx="15.5" cy="16.5" r="2" fill="#0A84FF"/>
            <circle cx="24.5" cy="16.5" r="2" fill="#0A84FF"/>
            <circle cx="20" cy="21.5" r="2" fill="#0A84FF"/>
            <path d="M9,12 C20,3 31,10 30,19" stroke="#72E3A6" stroke-width="1.5" fill="none"/>
            <circle cx="9" cy="12" r="2" fill="#72E3A6"/>
            <circle cx="30" cy="19" r="2" fill="#72E3A6"/>
          </g>
          <g transform="translate(52,12)">
            <text x="0" y="16" font-family="Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif"
                  font-size="22" font-weight="700" fill="var(--fcai-text)" letter-spacing="0.2">
              Fantacalcio
            </text>
            <rect x="111" y="2" width="4" height="22" rx="2" fill="#0A84FF"/>
            <text x="118" y="16" font-family="Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif"
                  font-size="18" font-weight="800" fill="#0A84FF" letter-spacing="0.4">
              AI
            </text>
            <text x="0" y="32" font-family="Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif"
                  font-size="10.5" fill="var(--fcai-text-dim)" letter-spacing="0.3">
              insights ‚Ä¢ aste ‚Ä¢ consigli in tempo reale
            </text>
          </g>
        </svg>
      </a>
      <nav class="spacer"></nav>
      <!-- Login Status Display -->
      <div id="user-status" style="display: flex; align-items: center; gap: 12px;">
        <!-- Logged out state -->
        <div id="logged-out-state">
          <a class="btn" href="#funzioni">Funzioni</a>
          <a class="btn" href="/auth/login" style="background: linear-gradient(135deg, #ffd700, #ffed4e); color: #333; font-weight: 700; border: 2px solid #ffd700;">
            <i style="font-size: 14px;">üëë</i> Accedi per PRO!
          </a>
          <a class="btn btn-primary" href="/auth/login">Accedi</a>
        </div>
        <!-- Logged in state -->
        <div id="logged-in-state" style="display: none;">
          <span id="user-greeting" style="margin-right: 10px; font-weight: 600; color: var(--fcai-primary);"></span>
          <a class="btn" href="/dashboard">Dashboard</a>
          <a class="btn btn-primary" href="/auth/logout">Logout</a>
        </div>
        <a class="btn btn-primary" href="/app">Apri App</a>
      </div>
      <!-- Theme Switcher -->
      <button id="theme-toggle" class="btn toggle" style="margin-left: 10px;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="11"></circle>
          <circle cx="12" cy="12" r="4"></circle>
          <line x1="12" y1="1" x2="12" y2="5"></line>
          <line x1="12" y1="19" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="7.03" y2="7.03"></line>
          <line x1="16.97" y1="16.97" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="5" y2="12"></line>
          <line x1="19" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="7.03" y2="16.97"></line>
          <line x1="16.97" y1="7.03" x2="19.78" y2="4.22"></line>
        </svg>
      </button>
    </div>
  </header>

  <section class="hero">
    <div class="container wrap">
      <div>
        <span class="kicker">‚öΩ + ü§ñ Consigli data-driven</span>
        <h1 class="h1">Aste intelligenti e consigli in tempo reale per la Serie A</h1>
        <p class="lead">Ranking dinamici, budget optimizer, scouting U21 e analisi avversari. Mobile-first, ora anche "website-like".</p>
        <div class="btn-group mt-2">
          <a class="btn cta" href="/app">Apri l'app</a>
          <a class="btn ghost" href="/dashboard">Leghe</a>
          <button class="btn ghost" onclick="openComparisonModal()">‚öñÔ∏è Confronta Giocatori</button>
          <button class="btn ghost" onclick="openModal('analyticsModal')">üìä Analytics</button>
        </div>
        <div class="kpis mt-3">
          <div class="kpi"><div class="label">Database giocatori</div><div class="value">500+</div></div>
          <div class="kpi"><div class="label">Ruoli & filtri</div><div class="value">30+</div></div>
          <div class="kpi"><div class="label">Consigli/ora</div><div class="value">‚àû</div></div>
          <div class="kpi"><div class="label">Modalit√†</div><div class="value">Classic ‚Ä¢ Mantra</div></div>
        </div
      </div>
      <div class="card pad">
        <div class="toolbar">
          <div class="search" style="flex:1">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15a7.5 7.5 0 0 1 0 15z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <input id="searchInput" type="text" placeholder="Cerca giocatori, squadra, ruolo‚Ä¶">
          </div>
          <button class="btn toggle" id="u21Toggle">U21</button>
          <button class="btn toggle active" id="formToggle">In forma</button>
          <button class="btn" id="advancedFiltersToggle">üîß Filtri</button>
        </div>
        
        <!-- Advanced Filters Panel -->
        <div id="advancedFiltersPanel" class="advanced-filters" style="display: none;">
          <div class="filter-grid">
            <div class="filter-group">
              <label>Prezzo</label>
              <div class="range-inputs">
                <input type="number" id="minPrice" placeholder="Min" min="0" max="100">
                <span>-</span>
                <input type="number" id="maxPrice" placeholder="Max" min="0" max="100">
              </div>
            </div>
            
            <div class="filter-group">
              <label>Fantamedia</label>
              <div class="range-inputs">
                <input type="number" id="minFM" placeholder="Min" min="0" max="10" step="0.1">
                <span>-</span>
                <input type="number" id="maxFM" placeholder="Max" min="0" max="10" step="0.1">
              </div>
            </div>
            
            <div class="filter-group">
              <label>Et√†</label>
              <div class="range-inputs">
                <input type="number" id="minAge" placeholder="Min" min="16" max="40">
                <span>-</span>
                <input type="number" id="maxAge" placeholder="Max" min="16" max="40">
              </div>
            </div>
            
            <div class="filter-group">
              <label>Ordina per</label>
              <select id="sortBy">
                <option value="fantamedia">Fantamedia</option>
                <option value="price">Prezzo</option>
                <option value="age">Et√†</option>
                <option value="name">Nome</option>
              </select>
              <select id="sortOrder">
                <option value="desc">Decrescente</option>
                <option value="asc">Crescente</option>
              </select>
            </div>
          </div>
          
          <div class="filter-actions">
            <button class="btn btn-secondary" id="clearFilters">Pulisci</button>
            <button class="btn btn-primary" id="applyFilters">Applica</button>
          </div>
        </div>
        <div class="mt-2">
          <div id="loadingIndicator" class="help">Caricamento dati giocatori...</div>
          
          <!-- Skeleton loading screen -->
          <div id="skeletonLoader" class="skeleton-container" style="display: none;">
            <div class="skeleton-table">
              <div class="skeleton-row skeleton-header">
                <div class="skeleton-cell"></div>
                <div class="skeleton-cell"></div>
                <div class="skeleton-cell"></div>
                <div class="skeleton-cell"></div>
                <div class="skeleton-cell"></div>
              </div>
              <div class="skeleton-row" v-for="i in 5">
                <div class="skeleton-cell skeleton-shimmer"></div>
                <div class="skeleton-cell skeleton-shimmer"></div>
                <div class="skeleton-cell skeleton-shimmer"></div>
                <div class="skeleton-cell skeleton-shimmer"></div>
                <div class="skeleton-cell skeleton-shimmer"></div>
              </div>
            </div>
          </div>
          
          <table class="table" id="playersTable" style="display: none;">
            <thead><tr><th>Nome</th><th>Ruolo</th><th>Squadra</th><th>Fantamedia</th><th>Prezzo</th></tr></thead>
            <tbody id="playersTableBody"></tbody>
          </table>
          <div id="playersCount" class="help mt-1"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Enhanced Features Section with 2x2 grid -->
  <section id="funzioni" class="section">
    <div class="container">
      <div class="grid-2" style="gap: 24px; margin-bottom: 32px;">
        <div class="card pad">
          <h2>üéØ Ranking & Fantamedia intelligente</h2>
          <p>Combina fantamedie storiche, xG/xA, forma e calendario. Filtri per ruolo avanzati con analisi predittiva.</p>
          <div class="btn-group mt-2">
            <button onclick="getTopPlayersByRole('A')" class="btn primary">Top Attaccanti</button>
            <button onclick="getTopPlayersByRole('C')" class="btn ghost">Top Centrocampisti</button>
          </div>
        </div>
        <div class="card pad">
          <h2>üí∞ Budget optimizer</h2>
          <p>Strategie d'asta simulate: aggressiva, bilanciata, low-cost con slot e vincoli di lega personalizzati.</p>
          <div class="btn-group mt-2">
            <button onclick="askFormationAdvice('3-5-2')" class="btn primary">Strategia 3-5-2</button>
            <button onclick="askFormationAdvice('4-3-3')" class="btn ghost">Strategia 4-3-3</button>
          </div>
        </div>
      </div>

      <div class="grid-2" style="gap: 24px;">
        <div class="card pad">
          <h2>üë∂ Scouting U21</h2>
          <p>Rileva prospetti con minuti crescenti e valore fantacalcistico in aumento. Algoritmi di machine learning.</p>
          <div class="btn-group mt-2">
            <button onclick="getU21PlayersByRole('A')" class="btn primary">U21 Attaccanti</button>
            <button onclick="getU21PlayersByRole('C')" class="btn ghost">U21 Centrocampisti</button>
          </div>
        </div>
        <div class="card pad">
          <h2>‚ö° Assistenza in tempo reale</h2>
          <p>Suggerimenti live per schieramento, cambi e ballottaggi. Notifiche automatiche sugli infortuni.</p>
          <div class="btn-group mt-2">
            <a class="btn primary" href="/app">Inizia ora</a>
            <button onclick="getTeamAcquisitions('Inter')" class="btn ghost">Acquisti Inter</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Conversational AI Assistant Section -->
  <section class="section">
    <div class="container">
      <h2 style="text-align: center; margin-bottom: 32px;">ü§ñ Assistente AI Conversazionale</h2>
      <div class="card pad" style="max-width: 800px; margin: 0 auto;">
        <div class="chat-container" style="min-height: 400px; border: 1px solid var(--input-border); border-radius: 12px; padding: 20px; background: var(--card-bg);">
          <div class="chat-header" style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid #e9ecef; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 8px; color: #666;">
              <div style="width: 10px; height: 10px; border-radius: 50%; background: #28a745; animation: pulse 2s infinite;"></div>
              <span>Assistente Online</span>
            </div>
            <div>
              <button onclick="resetDesktopChat()" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px;">Reset Chat</button>
            </div>
          </div>

          <div id="desktopChatMessages" style="min-height: 250px; max-height: 400px; overflow-y: auto; margin-bottom: 16px; scroll-behavior: smooth;">
            <div style="margin-bottom: 12px; padding: 12px 16px; border-radius: 16px; background: var(--chat-message-assistant-bg); color: var(--text-color); border-bottom-left-radius: 6px; max-width: 85%;">
              üëã Ciao! Sono il tuo assistente FantacalcioAI. Dimmi di cosa hai bisogno per la tua lega!
            </div>
          </div>

          <div id="desktopTypingIndicator" style="display: none; align-items: center; gap: 8px; padding: 10px 16px; background: var(--chat-message-assistant-bg); border-radius: 16px; max-width: 200px; margin-bottom: 12px;">
            <div style="display: flex; gap: 4px;">
              <span style="width: 8px; height: 8px; border-radius: 50%; background: #667eea; animation: typing 1.4s infinite;"></span>
              <span style="width: 8px; height: 8px; border-radius: 50%; background: #667eea; animation: typing 1.4s infinite; animation-delay: 0.15s;"></span>
              <span style="width: 8px; height: 8px; border-radius: 50%; background: #667eea; animation: typing 1.4s infinite; animation-delay: 0.3s;"></span>
            </div>
            <span>L'assistente sta scrivendo...</span>
          </div>

          <div style="display: flex; gap: 10px; align-items: flex-end;">
            <textarea id="desktopMessageInput" placeholder="Scrivi la tua domanda..." style="flex: 1; padding: 12px 16px; border: 2px solid #ddd; border-radius: 20px; outline: 0; font-size: 14px; min-height: 50px; resize: vertical; font-family: system-ui;"></textarea>
            <button onclick="openDesktopPlayerComparison()" style="background: linear-gradient(45deg, #f59e0b, #f97316); color: white; border: none; padding: 12px 18px; border-radius: 20px; cursor: pointer; font-weight: 600; margin-right: 8px;">‚öñÔ∏è Confronta</button>
            <button onclick="sendDesktopMessage()" style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; padding: 12px 18px; border-radius: 20px; cursor: pointer; font-weight: 600;">Invia</button>
          </div>
        </div>

        <!-- Duplicate buttons removed - main quick actions are below -->
      </div>
    </div>
  </section>

  <!-- Working Demo Section -->
  <section class="section alt">
    <div class="container grid-2">
      <div>
        <h2>Un'unica UI per mobile e desktop</h2>
        <p>La stessa base CSS gestisce l'interfaccia "app-like" e il layout "website-like". Meno manutenzione, pi√π consistenza.</p>
        <div class="btn-group mt-2">
          <a class="btn primary" href="/app">Apri App</a>
          <a class="btn" href="#funzioni">Vedi funzioni</a>
        </div>
      </div>
      <div class="card pad">
        <h3>üîß Configurazione Lega</h3>
        <form class="form" onsubmit="return handleLeagueSetup(event)">
          <div>
            <label class="label">Modalit√† di lega</label>
            <select class="select" id="leagueMode"><option>Classic</option><option>Mantra</option><option>Draft</option></select>
          </div>
          <div>
            <label class="label">Budget iniziale</label>
            <input class="input" type="number" id="initialBudget" placeholder="500" value="500"/>
            <div class="help">Valore per squadra</div>
          </div>
          <div>
            <label class="label">Formazione preferita</label>
            <select class="select" id="preferredFormation"><option>3-4-3</option><option>3-5-2</option><option>4-3-3</option><option>4-4-2</option></select>
          </div>
          <button type="submit" class="btn cta">Genera strategia d'asta</button>
        </form>
      </div>
    </div>
  </section>

  <!-- Quick Actions Section -->
  <section class="section alt">
    <div class="container">
      <h2 style="text-align: left; margin-bottom: 24px; margin-top: 0;">‚ö° Azioni Rapide</h2>
      <div class="quick-actions" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; max-width: 1200px; margin: 0;">
        <button onclick="askDesktopQuestion('Migliori attaccanti per budget 150 crediti?')" class="quick-action-btn">üéØ Top Attaccanti Budget</button>
        <button onclick="askDesktopQuestion('Top centrocampisti (budget 120)')" class="quick-action-btn">‚öΩ Top Centrocampisti</button>
        <button onclick="askDesktopQuestion('Top difensori (budget 100)')" class="quick-action-btn">üõ°Ô∏è Top Difensori</button>
        <button onclick="askDesktopQuestion('Migliori portieri budget 40')" class="quick-action-btn">ü•Ö Top Portieri</button>
        <button onclick="askDesktopQuestion('Formazione 3-5-2 con budget 500 crediti?')" class="quick-action-btn">‚öΩ Formazione 3-5-2</button>
        <button onclick="askDesktopQuestion('Formazione 4-3-3 (600 crediti)')" class="quick-action-btn">‚öΩ Formazione 4-3-3</button>
        <button onclick="askDesktopQuestion('Formazione 4-5-1 (450 crediti)')" class="quick-action-btn">‚öΩ Formazione 4-5-1</button>
        <button onclick="askDesktopQuestion('Formazione 3-4-3 (550 crediti)')" class="quick-action-btn">‚öΩ Formazione 3-4-3</button>
        <button onclick="askDesktopQuestion('2-3 difensori Under 21')" class="quick-action-btn">üë∂ U21 Difensori</button>
        <button onclick="askDesktopQuestion('3 centrocampisti Under 21')" class="quick-action-btn">üë∂ U21 Centrocampisti</button>
        <button onclick="askDesktopQuestion('2 attaccanti Under 21')" class="quick-action-btn">üë∂ U21 Attaccanti</button>
        <button onclick="askDesktopQuestion('Giovani Under 23 tutti i ruoli')" class="quick-action-btn">üë∂ U23 Tutti i Ruoli</button>
        <button onclick="askDesktopQuestion('Strategia per l\'asta')" class="quick-action-btn">üèÜ Strategia Asta</button>
        <button onclick="askDesktopQuestion('Ultimi acquisti Inter')" class="quick-action-btn">üìà Acquisti Inter</button>
        <button onclick="askDesktopQuestion('Ultimi acquisti Milan')" class="quick-action-btn">üìà Acquisti Milan</button>
        <button onclick="askDesktopQuestion('Ultimi acquisti Juventus')" class="quick-action-btn">üìà Acquisti Juventus</button>
        <button onclick="askDesktopQuestion('Ultimi acquisti Napoli')" class="quick-action-btn">üìà Acquisti Napoli</button>
        <button onclick="askDesktopQuestion('Ultimi acquisti Roma')" class="quick-action-btn">üìà Acquisti Roma</button>
        <button onclick="askDesktopQuestion('Ultimi acquisti Lazio')" class="quick-action-btn">üìà Acquisti Lazio</button>
        <button onclick="askDesktopQuestion('Ultimi acquisti Atalanta')" class="quick-action-btn">üìà Acquisti Atalanta</button>
        <button onclick="openModal('analyticsModal')" class="quick-action-btn">üìä Statistiche</button>
      </div>
    </div>
  </section>

  <!-- New Features Showcase Section -->
  <section class="section alt">
    <div class="container">
      <h2 style="text-align: center; margin-bottom: 32px;">üöÄ Nuove Funzionalit√†</h2>
      <div class="grid-3" style="gap: 24px;">
        <div class="card pad" style="text-align: center;">
          <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
          <h3 style="color: #667eea;">Real-time Updates</h3>
          <p style="margin-bottom: 20px; color: #666; line-height: 1.6;">Aggiornamenti in tempo reale visibili durante i giorni di partita per seguire le performance dei tuoi giocatori.</p>
          <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 4px solid #22d3ee;">
            <small style="color: #555;">üìà Disponibile durante le giornate di campionato</small>
          </div>
        </div>
        <div class="card pad" style="text-align: center;">
          <div style="font-size: 48px; margin-bottom: 16px;">ü§ñ</div>
          <h3 style="color: #667eea;">AI Insights</h3>
          <p style="margin-bottom: 20px; color: #666; line-height: 1.6;">Consigli avanzati dell'intelligenza artificiale disponibili in tutte le modalit√† chat per analisi personalizzate.</p>
          <button onclick="scrollToChat()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">üí¨ Prova ora nella Chat</button>
        </div>
        <div class="card pad" style="text-align: center;">
          <div style="font-size: 48px; margin-bottom: 16px;">üë•</div>
          <h3 style="color: #667eea;">Social Features</h3>
          <p style="margin-bottom: 20px; color: #666; line-height: 1.6;">Gestione leghe personalizzate, configurazioni avanzate e funzionalit√† sociali esclusive per utenti Pro.</p>
          <a href="/dashboard" style="background: linear-gradient(135deg, #ffd700, #ffb347); color: #333; text-decoration: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; display: inline-block; font-size: 14px;">‚≠ê Accedi alle Leghe</a>
        </div>
      </div>
    </div>
  </section>

  <!-- Live Player Data Section -->
  <section class="section">
    <div class="container">
      <h2 style="text-align: center; margin-bottom: 32px;">üî• Dati Live Serie A 2025-26</h2>
      <div id="liveDataContainer" class="grid-2" style="gap: 24px;">
        <div class="card pad">
          <h3>‚öΩ Top Attaccanti</h3>
          <div id="topAttackers">Caricamento...</div>
        </div>
        <div class="card pad">
          <h3>üéØ Top Centrocampisti</h3>
          <div id="topMidfielders">Caricamento...</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Player Comparison Modal -->
  <div id="comparisonModal" class="modal">
    <div class="dialog">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">‚öñÔ∏è Confronta Giocatori</h3>
        <button onclick="closeComparisonModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
      </div>
      <div style="margin-bottom: 20px;">
        <input id="player1Input" placeholder="Nome del primo giocatore..." style="width: 100%; margin-bottom: 10px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
        <input id="player2Input" placeholder="Nome del secondo giocatore..." style="width: 100%; margin-bottom: 15px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
        <button onclick="comparePlayersDesktop()" style="width: 100%; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer;">Confronta</button>
      </div>
      <div id="comparisonResults" style="margin-top: 20px;"></div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">¬© <span id="y"></span> FantacalcioAI. Tutti i diritti riservati.</div>
  </footer>

  <script>
    document.getElementById('y').textContent=new Date().getFullYear();

    // --- Theme Toggle Functionality ---
    const themeToggle = document.getElementById('theme-toggle');
    const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');

    function toggleTheme(theme) {
      if (theme === 'dark') {
        document.body.classList.add('dark-theme');
        themeToggle.classList.add('active'); // Indicate dark mode is active
      } else {
        document.body.classList.remove('dark-theme');
        themeToggle.classList.remove('active'); // Indicate light mode is active
      }
      localStorage.setItem('theme', theme);
    }

    function checkAndApplyTheme() {
      let savedTheme = localStorage.getItem('theme');
      if (!savedTheme && prefersDarkScheme.matches) {
        savedTheme = 'dark';
      }
      toggleTheme(savedTheme || 'light');
    }

    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        const currentTheme = document.body.classList.contains('dark-theme') ? 'light' : 'dark';
        toggleTheme(currentTheme);
      });
    }

    // Apply theme on load
    checkAndApplyTheme();

    // --- Enhanced User Session Management ---
    async function checkUserSession() {
      try {
        const response = await fetch('/api/user/status');
        if (response.ok) {
          const userData = await response.json();
          updateLoginStatus(userData.logged_in, userData.user);
        } else {
          updateLoginStatus(false);
        }
      } catch (error) {
        console.log('User session check failed:', error);
        updateLoginStatus(false);
      }
    }

    function updateLoginStatus(isLoggedIn, user = null) {
      const loggedOutState = document.getElementById('logged-out-state');
      const loggedInState = document.getElementById('logged-in-state');
      const userGreeting = document.getElementById('user-greeting');

      if (isLoggedIn && user) {
        loggedOutState.style.display = 'none';
        loggedInState.style.display = 'flex';
        
        const displayName = user.first_name || user.username || 'Utente';
        const isPro = user.pro_expires_at && new Date(user.pro_expires_at) > new Date();
        
        userGreeting.innerHTML = `
          <span style="color: var(--fcai-primary);">Ciao, ${displayName}</span>
          ${isPro ? '<span class="badge" style="background: linear-gradient(135deg, #ffd700, #ffed4e); color: #333; margin-left: 8px;">PRO</span>' : ''}
        `;
      } else {
        loggedOutState.style.display = 'flex';
        loggedInState.style.display = 'none';
      }
    }

    // Check session on page load
    document.addEventListener('DOMContentLoaded', function() {
      checkUserSession();
    });


    // Desktop Quick Action Functions
    function openComparisonModal() {
        const modal = document.getElementById('desktopComparisonModal');
        if (modal) {
            modal.style.display = 'flex';
            // Clear previous inputs and results
            document.getElementById('desktopPlayer1Input').value = '';
            document.getElementById('desktopPlayer2Input').value = '';
            document.getElementById('desktopComparisonResults').innerHTML = '';
        }
    }

    function getTopPlayersByRole(role) {
        const queries = {
            'A': 'Top 5 attaccanti con miglior rapporto qualit√†/prezzo',
            'C': 'Top 5 centrocampisti con miglior rapporto qualit√†/prezzo',
            'D': 'Top 5 difensori con miglior rapporto qualit√†/prezzo',
            'P': 'Top 5 portieri con miglior rapporto qualit√†/prezzo'
        };
        
        if (queries[role]) {
            sendDesktopMessage(queries[role]);
        }
    }

    function askFormationAdvice(formation) {
        const message = `Consiglia una formazione ${formation} ottimizzata per budget 500 crediti`;
        sendDesktopMessage(message);
    }

    // Function to scroll to chat for AI Insights
    function scrollToChat() {
        console.log('scrollToChat function called');
        
        // Find the desktop chat input
        const chatInput = document.getElementById('desktopMessageInput');
        const chatSection = document.querySelector('.chat-container');
        
        console.log('chatSection found:', !!chatSection);
        console.log('chatInput found:', !!chatInput);
        
        if (chatSection && chatInput) {
            chatSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // Focus on the chat input
            setTimeout(() => {
                chatInput.focus();
                chatInput.placeholder = "Chiedi consigli AI personalizzati per la tua lega...";
                console.log('Desktop chat input focused and placeholder set');
            }, 800);
        } else {
            console.error('Could not find desktop chat section or input');
            // Try alternative selectors for the chat area
            const alternativeChat = document.querySelector('#desktopChatMessages, .chat-messages, textarea[placeholder*="domanda"]');
            if (alternativeChat) {
                alternativeChat.scrollIntoView({ behavior: 'smooth' });
                // Try to find and focus any available text input
                const anyInput = document.querySelector('#desktopMessageInput, textarea');
                if (anyInput) {
                    anyInput.focus();
                }
                console.log('Used alternative chat selector');
            }
        }
    }

    // Function for quick action buttons - show results in modal
    async function askDesktopQuestion(question) {
        console.log('askDesktopQuestion called with:', question);
        
        // Show loading modal
        showQuickActionModal('‚è≥ Caricamento...', 'Sto elaborando la tua richiesta...');
        
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: question, mode: 'classic' })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Show result in modal
            const title = question.includes('attaccanti') ? 'üéØ Top Attaccanti' :
                         question.includes('centrocampisti') ? '‚öΩ Top Centrocampisti' :
                         question.includes('difensori') ? 'üõ°Ô∏è Top Difensori' :
                         question.includes('portieri') ? 'ü•Ö Top Portieri' :
                         question.includes('Formazione') ? '‚öΩ Strategia Formazione' :
                         question.includes('Under') ? 'üë∂ Giovani Talenti' :
                         question.includes('acquisti') ? 'üìà Ultimi Acquisti' :
                         'ü§ñ FantacalcioAI';
                         
            showQuickActionModal(title, data.response || 'Risposta non disponibile');
            
        } catch (error) {
            console.error('Quick action error:', error);
            showQuickActionModal('‚ùå Errore', 'Errore nella richiesta. Riprova pi√π tardi.');
        }
    }

    // Show quick action results in modal
    function showQuickActionModal(title, content) {
        // Create modal if it doesn't exist
        let modal = document.getElementById('quickActionModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'quickActionModal';
            modal.style.cssText = `
                display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
                background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center;
            `;
            
            // Detect if dark mode is active and set appropriate colors
            const isDarkMode = document.documentElement.classList.contains('dark') || 
                             document.body.classList.contains('dark') ||
                             window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            const modalBg = isDarkMode ? '#1f2937' : '#ffffff';
            const titleColor = isDarkMode ? '#f9fafb' : '#1f2937';
            const contentColor = isDarkMode ? '#e5e7eb' : '#374151';
            const buttonColor = isDarkMode ? '#9ca3af' : '#6b7280';
            
            modal.innerHTML = `
                <div style="background: ${modalBg}; border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 id="quickActionTitle" style="margin: 0; color: ${titleColor}; font-size: 1.5rem; font-weight: 600;"></h2>
                        <button onclick="closeQuickActionModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: ${buttonColor}; padding: 4px; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='none'">&times;</button>
                    </div>
                    <div id="quickActionContent" style="line-height: 1.6; color: ${contentColor}; font-size: 14px;"></div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Update content and show
        document.getElementById('quickActionTitle').textContent = title;
        document.getElementById('quickActionContent').innerHTML = content;
        modal.style.display = 'flex';
    }

    function closeQuickActionModal() {
        const modal = document.getElementById('quickActionModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('quickActionModal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });

    // Desktop Chat Functionality
    let isDesktopProcessing = false;
    
    async function sendDesktopMessage(customMessage = null) {
        console.log('sendDesktopMessage called with:', customMessage);
        
        if (isDesktopProcessing) {
            console.log('Already processing a question, ignoring duplicate call');
            return;
        }
        
        const input = document.getElementById('desktopMessageInput');
        const container = document.getElementById('desktopChatMessages');
        const typing = document.getElementById('desktopTypingIndicator');

        if (!input || !container) {
            console.error('Required elements not found:', { input: !!input, container: !!container });
            return;
        }

        const message = customMessage || input.value.trim();
        console.log('Message to send:', message);
        if (!message) return;
        
        isDesktopProcessing = true;

        // Add user message
        const userMsg = document.createElement('div');
        userMsg.style.cssText = `
            margin-bottom: 12px; padding: 12px 16px; border-radius: 16px; max-width: 85%;
            margin-left: auto; border-bottom-right-radius: 6px;
            background: #667eea; color: white;
            text-align: right;
        `;
        userMsg.textContent = message;
        container.appendChild(userMsg);

        // Clear input and scroll (only if not custom message)
        if (!customMessage) {
            input.value = '';
        }
        container.scrollTop = container.scrollHeight;

        // Show typing indicator
        if (typing) {
            typing.style.display = 'flex';
        }

        try {
            console.log('Sending request to /api/chat');
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message, mode: 'classic' })
            });

            console.log('Response status:', response.status);

            // Hide typing indicator
            if (typing) {
                typing.style.display = 'none';
            }

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('Response data:', data);
            console.log('Container found:', !!container);
            console.log('Container children before:', container.children.length);

            // Add assistant response
            const assistantMsg = document.createElement('div');
            assistantMsg.style.cssText = `
                margin-bottom: 12px; padding: 12px 16px; border-radius: 16px; max-width: 85%;
                background: var(--chat-message-assistant-bg); color: var(--text-color); border-bottom-left-radius: 6px;
                border: 2px solid #28a745; font-weight: bold;
            `;
            assistantMsg.innerHTML = data.response || 'Risposta non disponibile';
            container.appendChild(assistantMsg);
            
            console.log('Container children after:', container.children.length);
            console.log('Message added:', assistantMsg.innerHTML.substring(0, 50));

            container.scrollTop = container.scrollHeight;

        } catch (error) {
            console.error('Chat error:', error);
            
            // Hide typing indicator
            if (typing) {
                typing.style.display = 'none';
            }

            const errorMsg = document.createElement('div');
            errorMsg.style.cssText = `
                margin-bottom: 12px; padding: 12px 16px; border-radius: 16px; max-width: 85%;
                background: var(--error-bg, #ffebee); color: var(--error-text, #c62828); border-bottom-left-radius: 6px;
            `;
            errorMsg.innerHTML = '‚ùå Errore di connessione: ' + error.message;
            container.appendChild(errorMsg);

            container.scrollTop = container.scrollHeight;
        } finally {
            isDesktopProcessing = false;
        }
    }


    function resetDesktopChat() {
        const container = document.getElementById('desktopChatMessages');
        if (container) {
            container.innerHTML = `
                <div style="margin-bottom: 12px; padding: 12px 16px; border-radius: 16px; background: var(--chat-message-assistant-bg); color: var(--text-color); border-bottom-left-radius: 6px; max-width: 85%;">
                    üëã Ciao! Sono il tuo assistente FantacalcioAI. Dimmi di cosa hai bisogno per la tua lega!
                </div>
            `;
        }
    }


    // Add enter key support for desktop chat
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded - setting up desktop chat');
        const desktopInput = document.getElementById('desktopMessageInput');
        if (desktopInput) {
            console.log('Desktop input found, adding event listener');
            desktopInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendDesktopMessage();
                }
            });
        } else {
            console.error('Desktop input not found during DOMContentLoaded');
        }
    });

    // Add CSS animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.55; }
        }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }
    `;
    document.head.appendChild(style);

    // Desktop App Functionality - Real API Integration
    let currentRole = 'all';
    let playersData = [];

    // Load real player data when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadPlayersData();
        setupEventListeners();
        loadLiveData();
    });

    function setupEventListeners() {
        // Search functionality with debouncing
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            let searchTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    filterAndDisplayPlayers();
                }, 300);
            });
        }

        // Toggle buttons
        const u21Toggle = document.getElementById('u21Toggle');
        const formToggle = document.getElementById('formToggle');

        if (u21Toggle) {
            u21Toggle.addEventListener('click', function() {
                this.classList.toggle('active');
                filterAndDisplayPlayers();
            });
        }

        if (formToggle) {
            formToggle.addEventListener('click', function() {
                this.classList.toggle('active');
                filterAndDisplayPlayers();
            });
        }

        // Add event listeners for sort dropdowns
        const sortBy = document.getElementById('sortBy');
        const sortOrder = document.getElementById('sortOrder');
        
        if (sortBy) {
            sortBy.addEventListener('change', function() {
                filterAndDisplayPlayers();
            });
        }
        
        if (sortOrder) {
            sortOrder.addEventListener('change', function() {
                filterAndDisplayPlayers();
            });
        }
    }

    async function loadPlayersData() {
        await searchPlayers();
    }

    async function searchPlayers() {
        try {
            const searchInputEl = document.getElementById('searchInput');
            const searchQuery = searchInputEl ? searchInputEl.value : '';
            const u21ToggleEl = document.getElementById('u21Toggle');
            const isU21Active = u21ToggleEl ? u21ToggleEl.classList.contains('active') : false;
            const formToggleEl = document.getElementById('formToggle');
            const isFormActive = formToggleEl ? formToggleEl.classList.contains('active') : false;
            
            // Get sort parameters
            const sortByEl = document.getElementById('sortBy');
            const sortBy = sortByEl ? sortByEl.value : 'fantamedia';
            const sortOrderEl = document.getElementById('sortOrder');
            const sortOrder = sortOrderEl ? sortOrderEl.value : 'desc';

            const params = new URLSearchParams();
            if (searchQuery) params.append('search', searchQuery);
            if (isU21Active) params.append('u21', 'true');
            if (isFormActive) params.append('in_forma', 'true');
            params.append('limit', '50');
            params.append('sort_by', sortBy);
            params.append('sort_order', sortOrder);

            const response = await fetch(`/api/players?${params.toString()}`);
            const data = await response.json();

            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }

            const table = document.getElementById('playersTable');
            if (table) {
                table.style.display = 'table';
            }

            const players = data.players || [];
            displayPlayers(players);
            updatePlayersCount(players.length, data.total || 0);

        } catch (error) {
            console.error('Error loading players data:', error);
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.textContent = 'Errore nel caricamento dei dati. Riprova pi√π tardi.';
            }
        }
    }

    function filterAndDisplayPlayers() {
        searchPlayers();
    }

    function displayPlayers(players) {
        const tbody = document.getElementById('playersTableBody');
        if (!tbody) return;

        tbody.innerHTML = players.map(player => `
            <tr>
                <td><strong>${player.display_name || player.name}</strong></td>
                <td><span style="padding: 4px 8px; border-radius: 8px; font-size: 12px; font-weight: bold; color: white; background: ${getRoleColor(player.role)}">${player.role}</span></td>
                <td>${player.team}</td>
                <td>${player.fantamedia || 0}</td>
                <td>‚Ç¨${player.price || 0}</td>
            </tr>
        `).join('');
    }

    function updatePlayersCount(displayed, total) {
        const countElement = document.getElementById('playersCount');
        if (countElement) {
            countElement.textContent = `Visualizzati ${displayed} di ${total} giocatori trovati - dati reali da FantacalcioAI`;
        }
    }

    function getRoleColor(role) {
        const colors = {
            'P': '#22C55E',
            'D': '#3B82F6',
            'C': '#F59E0B',
            'A': '#EF4444'
        };
        return colors[role] || '#6B7280';
    }

    function showQuickResult(title, message) {
        const resultDiv = document.createElement('div');
        resultDiv.style.cssText = `
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 24px; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px; z-index: 1000; color: #333; font-family: system-ui;
        `;
        resultDiv.innerHTML = `
            <h3 style="margin: 0 0 16px 0; color: #667eea;">${title}</h3>
            <p style="margin: 0 0 20px 0; line-height: 1.6;">${message}</p>
            <button onclick="this.parentElement.remove(); document.getElementById('overlay').remove()" 
                    style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">Chiudi</button>
        `;

        const overlay = document.createElement('div');
        overlay.id = 'overlay';
        overlay.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 999;
        `;
        overlay.onclick = () => { resultDiv.remove(); overlay.remove(); };

        document.body.appendChild(overlay);
        document.body.appendChild(resultDiv);
    }

    async function getTopPlayersByRole(role) {
        try {
            const response = await fetch(`/api/players?role=${role}&in_forma=true&limit=5`);
            const data = await response.json();
            const players = data.players || [];

            const roleNames = { 'A': 'Attaccanti', 'C': 'Centrocampisti', 'D': 'Difensori', 'P': 'Portieri' };
            const roleName = roleNames[role] || 'Giocatori';

            if (players.length > 0) {
                const playersList = players.map(p => `${p.display_name || p.name} (${p.team}, FM ${p.fantamedia})`).join(', ');
                showQuickResult(`üéØ Top ${roleName}`, `I migliori ${roleName.toLowerCase()} in forma: ${playersList}`);
            } else {
                showQuickResult(`üéØ Top ${roleName}`, `Nessun ${roleName.toLowerCase()} trovato in questo momento.`);
            }
        } catch (error) {
            showQuickResult('‚ùå Errore', 'Errore nel caricamento dei dati. Riprova pi√π tardi.');
        }
    }

    async function getU21PlayersByRole(role) {
        try {
            const response = await fetch(`/api/players?role=${role}&u21=true&limit=5`);
            const data = await response.json();
            const players = data.players || [];

            const roleNames = { 'A': 'Attaccanti', 'C': 'Centrocampisti', 'D': 'Difensori', 'P': 'Portieri' };
            const roleName = roleNames[role] || 'Giocatori';

            if (players.length > 0) {
                const playersList = players.map(p => `${p.display_name || p.name} (${p.team})`).join(', ');
                showQuickResult(`üë∂ U21 ${roleName}`, `I migliori ${roleName.toLowerCase()} Under 21: ${playersList}`);
            } else {
                showQuickResult(`üë∂ U21 ${roleName}`, `Nessun ${roleName.toLowerCase()} Under 21 trovato in questo momento.`);
            }
        } catch (error) {
            showQuickResult('‚ùå Errore', 'Errore nel caricamento dei dati. Riprova pi√π tardi.');
        }
    }

    async function askFormationAdvice(formation) {
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: `Consigli per formazione ${formation}` })
            });
            const data = await response.json();
            showQuickResult(`‚öΩ Formazione ${formation}`, data.response || 'Consigli per formazione non disponibili al momento.');
        } catch (error) {
            showQuickResult('‚ùå Errore', 'Errore nel caricamento dei consigli. Riprova pi√π tardi.');
        }
    }

    async function getTeamAcquisitions(team) {
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: `Ultimi acquisti ${team}` })
            });
            const data = await response.json();
            showQuickResult(`üìà Acquisti ${team}`, data.response || 'Informazioni sugli acquisti non disponibili al momento.');
        } catch (error) {
            showQuickResult('‚ùå Errore', 'Errore nel caricamento delle informazioni. Riprova pi√π tardi.');
        }
    }

    function handleLeagueSetup(event) {
        event.preventDefault();
        const mode = document.getElementById('leagueMode').value;
        const budget = document.getElementById('initialBudget').value;
        const formation = document.getElementById('preferredFormation').value;

        showQuickResult(
            'üèÜ Strategia Personalizzata', 
            `Modalit√†: ${mode} | Budget: ‚Ç¨${budget} | Formazione: ${formation}<br><br>` +
            `‚úÖ Strategia consigliata: concentra il 60% del budget sui top player, diversifica per ruolo, ` +
            `punta sui giovani U21 per il futuro. Inizia con la formazione ${formation} e adatta in base agli acquisti.`
        );
        return false;
    }

    // Test function to verify quick actions are working
    function testQuickAction() {
        console.log('Quick action test successful!');
        askDesktopQuestion('Ciao, funzioni correttamente?');
    }

    async function askQuickQuestion(question) {
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: question, mode: 'classic' })
            });
            const data = await response.json();
            showQuickResult('ü§ñ Risposta FantacalcioAI', data.response || 'Risposta non disponibile al momento.');
        } catch (error) {
            showQuickResult('‚ùå Errore', 'Errore nella comunicazione con l\'assistente. Riprova pi√π tardi.');
        }
    }

    // Player comparison functions
    function openComparisonModal() {
      const modal = document.getElementById('comparisonModal');
      modal.classList.add('show');
      // Clear previous inputs and results
      document.getElementById('player1Input').value = '';
      document.getElementById('player2Input').value = '';
      document.getElementById('comparisonResults').innerHTML = '';
    }

    function closeComparisonModal() {
      const modal = document.getElementById('comparisonModal');
      modal.classList.remove('show');
    }

    async function comparePlayersDesktop() {
      const p1 = document.getElementById('player1Input').value.trim();
      const p2 = document.getElementById('player2Input').value.trim();
      
      if (!p1 || !p2) {
        alert('Inserisci entrambi i giocatori');
        return;
      }

      const results = document.getElementById('comparisonResults');
      results.innerHTML = '<div style="text-align: center; padding: 20px;">üîÑ Caricamento confronto...</div>';

      try {
        const response = await fetch('/api/compare', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ players: [p1, p2] })
        });

        const data = await response.json();

        if (!data.comparison || data.comparison.length < 2) {
          results.innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444;">‚ùå Uno o entrambi i giocatori non sono stati trovati</div>';
          return;
        }

        const player1 = data.comparison[0];
        const player2 = data.comparison[1];

        results.innerHTML = `
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
              <thead>
                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                  <th style="padding: 12px; text-align: left; font-weight: 600;">Caratteristica</th>
                  <th style="padding: 12px; text-align: center; font-weight: 600; color: #667eea;">${player1.name || 'Giocatore 1'}</th>
                  <th style="padding: 12px; text-align: center; font-weight: 600; color: #7c3aed;">${player2.name || 'Giocatore 2'}</th>
                </tr>
              </thead>
              <tbody>
                <tr style="border-bottom: 1px solid #dee2e6;">
                  <td style="padding: 10px; font-weight: 500;">Squadra</td>
                  <td style="padding: 10px; text-align: center;">${player1.team || '-'}</td>
                  <td style="padding: 10px; text-align: center;">${player2.team || '-'}</td>
                </tr>
                <tr style="border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                  <td style="padding: 10px; font-weight: 500;">Ruolo</td>
                  <td style="padding: 10px; text-align: center;">${player1.role || '-'}</td>
                  <td style="padding: 10px; text-align: center;">${player2.role || '-'}</td>
                </tr>
                <tr style="border-bottom: 1px solid #dee2e6;">
                  <td style="padding: 10px; font-weight: 500;">Fantamedia</td>
                  <td style="padding: 10px; text-align: center; font-weight: 600; color: ${player1.fantamedia > player2.fantamedia ? '#22c55e' : '#6b7280'};">${player1.fantamedia || 0}</td>
                  <td style="padding: 10px; text-align: center; font-weight: 600; color: ${player2.fantamedia > player1.fantamedia ? '#22c55e' : '#6b7280'};">${player2.fantamedia || 0}</td>
                </tr>
                <tr style="border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                  <td style="padding: 10px; font-weight: 500;">Prezzo</td>
                  <td style="padding: 10px; text-align: center; font-weight: 600;">‚Ç¨${player1.price || 0}</td>
                  <td style="padding: 10px; text-align: center; font-weight: 600;">‚Ç¨${player2.price || 0}</td>
                </tr>
                <tr style="border-bottom: 1px solid #dee2e6;">
                  <td style="padding: 10px; font-weight: 500;">Et√†</td>
                  <td style="padding: 10px; text-align: center;">${player1.age || '-'}</td>
                  <td style="padding: 10px; text-align: center;">${player2.age || '-'}</td>
                </tr>
                <tr>
                  <td style="padding: 10px; font-weight: 500;">Presenze</td>
                  <td style="padding: 10px; text-align: center;">${player1.appearances || '-'}</td>
                  <td style="padding: 10px; text-align: center;">${player2.appearances || '-'}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div style="margin-top: 15px; padding: 10px; background: #f0f9ff; border-left: 4px solid #0ea5e9; border-radius: 4px; font-size: 13px;">
            üí° <strong>Suggerimento:</strong> 
            ${player1.fantamedia > player2.fantamedia 
              ? `${player1.name} ha una fantamedia superiore (+${(player1.fantamedia - player2.fantamedia).toFixed(1)})` 
              : player2.fantamedia > player1.fantamedia
              ? `${player2.name} ha una fantamedia superiore (+${(player2.fantamedia - player1.fantamedia).toFixed(1)})`
              : 'Entrambi i giocatori hanno fantamedia simili'}
          </div>
        `;

      } catch (error) {
        console.error('Comparison error:', error);
        results.innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444;">‚ùå Errore nel confronto. Riprova pi√π tardi.</div>';
      }
    }

    // Close modal when clicking outside
    document.addEventListener('click', function(event) {
      const modal = document.getElementById('comparisonModal');
      if (event.target === modal) {
        closeComparisonModal();
      }
    });

    async function loadLiveData() {
        try {
            // Load top attackers
            const attackersResponse = await fetch('/api/players?role=A&in_forma=true&limit=3');
            const attackersData = await attackersResponse.json();
            const topAttackers = attackersData.players || [];

            // Load top midfielders
            const midfieldersResponse = await fetch('/api/players?role=C&in_forma=true&limit=3');
            const midfieldersData = await midfieldersResponse.json();
            const topMidfielders = midfieldersData.players || [];

            // Display top attackers
            const attackersContainer = document.getElementById('topAttackers');
            if (attackersContainer && topAttackers.length > 0) {
                attackersContainer.innerHTML = topAttackers.map((player, index) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee;">
                        <div>
                            <strong>${player.display_name || player.name}</strong><br>
                            <small style="color: #666;">${player.team}</small>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: bold; color: #EF4444;">FM ${player.fantamedia}</div>
                            <div style="font-size: 12px; color: #666;">‚Ç¨${player.price}</div>
                        </div>
                    </div>
                `).join('');
            }

            // Display top midfielders
            const midfieldersContainer = document.getElementById('topMidfielders');
            if (midfieldersContainer && topMidfielders.length > 0) {
                midfieldersContainer.innerHTML = topMidfielders.map((player, index) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee;">
                        <div>
                            <strong>${player.display_name || player.name}</strong><br>
                            <small style="color: #666;">${player.team}</small>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: bold; color: #F59E0B;">FM ${player.fantamedia}</div>
                            <div style="font-size: 12px; color: #666;">‚Ç¨${player.price}</div>
                        </div>
                    </div>
                `).join('');
            }

        } catch (error) {
            console.error('Error loading live data:', error);
        }
    }
    // Player comparison modal functions for desktop
    function openDesktopPlayerComparison() {
        const modal = document.getElementById('desktopComparisonModal');
        if (modal) {
            modal.style.display = 'flex';
            // Clear previous inputs and results
            document.getElementById('desktopPlayer1Input').value = '';
            document.getElementById('desktopPlayer2Input').value = '';
            document.getElementById('desktopComparisonResults').innerHTML = '';
        }
    }

    function closeDesktopModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
        }
    }

    async function compareDesktopPlayers() {
        const player1Name = document.getElementById('desktopPlayer1Input').value.trim();
        const player2Name = document.getElementById('desktopPlayer2Input').value.trim();
        const resultsDiv = document.getElementById('desktopComparisonResults');

        if (!player1Name || !player2Name) {
            resultsDiv.innerHTML = `
                <div style="color: var(--error-text); text-align: center; padding: 20px;">
                    ‚ö†Ô∏è Per favore inserisci entrambi i nomi dei giocatori
                </div>`;
            return;
        }

        resultsDiv.innerHTML = `
            <div style="color: var(--text-color); text-align: center; padding: 20px;">
                üîÑ Confrontando ${player1Name} vs ${player2Name}...
            </div>`;

        try {
            const response = await fetch('/api/compare', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    players: [player1Name, player2Name]
                })
            });

            if (response.ok) {
                const data = await response.json();
                console.log('Comparison data:', data);
                
                if (!(data.comparison && data.comparison.length >= 2)) {
                    resultsDiv.innerHTML = '‚ùå Giocatori non trovati';
                    return;
                }
                
                const player1 = data.comparison[0];
                const player2 = data.comparison[1] || {};
                
                resultsDiv.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse; background: var(--card-bg); border-radius: 8px; overflow: hidden; color: var(--text-color);">
                        <thead>
                            <tr style="background: var(--comparison-header-bg);">
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-color);">Statistica</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--comparison-player1-color);">${player1.name || '-'}</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--comparison-player2-color);">${player2.name || '-'}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid var(--input-border);">
                                <td style="padding: 10px; font-weight: 500;">Squadra</td>
                                <td style="padding: 10px; text-align: center;">${player1.team || '-'}</td>
                                <td style="padding: 10px; text-align: center;">${player2.team || '-'}</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--input-border); background: var(--table-row-bg);">
                                <td style="padding: 10px; font-weight: 500;">Fantamedia</td>
                                <td style="padding: 10px; text-align: center; font-weight: bold; color: var(--comparison-player1-color);">${player1.fantamedia ?? '-'}</td>
                                <td style="padding: 10px; text-align: center; font-weight: bold; color: var(--comparison-player2-color);">${player2.fantamedia ?? '-'}</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--input-border);">
                                <td style="padding: 10px; font-weight: 500;">Prezzo</td>
                                <td style="padding: 10px; text-align: center;">‚Ç¨${player1.price ?? '-'}</td>
                                <td style="padding: 10px; text-align: center;">‚Ç¨${player2.price ?? '-'}</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--input-border); background: var(--table-row-bg);">
                                <td style="padding: 10px; font-weight: 500;">Presenze</td>
                                <td style="padding: 10px; text-align: center;">${player1.appearances ?? '-'}</td>
                                <td style="padding: 10px; text-align: center;">${player2.appearances ?? '-'}</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--input-border);">
                                <td style="padding: 10px; font-weight: 500;">Et√†</td>
                                <td style="padding: 10px; text-align: center;">${player1.age ?? '-'}</td>
                                <td style="padding: 10px; text-align: center;">${player2.age ?? '-'}</td>
                            </tr>
                            <tr style="background: var(--table-row-bg);">
                                <td style="padding: 10px; font-weight: 500;">Goal</td>
                                <td style="padding: 10px; text-align: center;">${player1.gol ?? '-'}</td>
                                <td style="padding: 10px; text-align: center;">${player2.gol ?? '-'}</td>
                            </tr>
                        </tbody>
                    </table>`;
            } else {
                throw new Error('Errore nella richiesta');
            }
        } catch (error) {
            console.error('Error comparing players:', error);
            resultsDiv.innerHTML = `
                <div style="color: var(--error-text); text-align: center; padding: 20px;">
                    ‚ùå Errore nel confronto. Riprova pi√π tardi.
                </div>`;
        }
    }

    // Load Analytics Function (Missing function causing hanging)
    async function loadAnalytics() {
        const loading = document.getElementById('analyticsLoading');
        const data = document.getElementById('analyticsData');
        
        if (loading) loading.style.display = 'block';
        if (data) data.style.display = 'none';
        
        try {
            // Load statistics data
            const statsResponse = await fetch('/api/statistics');
            const statsData = await statsResponse.json();
            
            // Build analytics HTML with theme-aware styling
            let analyticsHtml = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    
                    <!-- Data Quality Overview -->
                    <div class="analytics-card" style="background: var(--card-bg); border: 1px solid var(--input-border); border-radius: 12px; padding: 20px;">
                        <h3 style="color: var(--text-color); margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                            üìà <span>Data Quality</span>
                        </h3>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-color); opacity: 0.8;">Total Players:</span>
                                <span style="color: #22d3ee; font-weight: bold;">${statsData.total_players || 0}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-color); opacity: 0.8;">Active Filters:</span>
                                <span style="color: #22d3ee; font-weight: bold;">${statsData.active_filters || 'None'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Role Distribution -->
                    <div class="analytics-card" style="background: var(--card-bg); border: 1px solid var(--input-border); border-radius: 12px; padding: 20px;">
                        <h3 style="color: var(--text-color); margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                            ‚öΩ <span>Role Distribution</span>
                        </h3>
                        <div style="display: grid; gap: 8px;">
            `;
            
            // Add role statistics
            const roleNames = { 'P': 'Portieri', 'D': 'Difensori', 'C': 'Centrocampisti', 'A': 'Attaccanti' };
            Object.entries(statsData.role_statistics || {}).forEach(([role, stats]) => {
                analyticsHtml += `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--text-color);">${roleNames[role] || role}:</span>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span style="color: #22d3ee; font-weight: bold;">${stats.count || 0}</span>
                            <span style="color: var(--text-color); opacity: 0.6; font-size: 12px;">avg ‚Ç¨${stats.avg_price || 0}</span>
                        </div>
                    </div>
                `;
            });
            
            analyticsHtml += `
                        </div>
                    </div>
                </div>
                
                <!-- Top Players Section -->
                <div style="margin-top: 20px; background: var(--card-bg); border: 1px solid var(--input-border); border-radius: 12px; padding: 20px;">
                    <h3 style="color: var(--text-color); margin: 0 0 15px 0;">üèÜ Top Players by Role</h3>
                    <div style="display: grid; gap: 15px;">
            `;
            
            // Add top players for each role
            Object.entries(statsData.role_statistics || {}).forEach(([role, stats]) => {
                if (stats.top_players && stats.top_players.length > 0) {
                    analyticsHtml += `
                        <div>
                            <h4 style="color: var(--text-color); margin: 0 0 8px 0; font-size: 14px;">${roleNames[role] || role}</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    `;
                    
                    stats.top_players.slice(0, 3).forEach(player => {
                        analyticsHtml += `
                            <span style="background: var(--secondary-btn-bg); color: var(--text-color); padding: 4px 8px; border-radius: 6px; font-size: 12px;">
                                ${player.name} (FM: ${player.fantamedia}, ‚Ç¨${player.price})
                            </span>
                        `;
                    });
                    
                    analyticsHtml += `
                            </div>
                        </div>
                    `;
                }
            });
            
            analyticsHtml += `
                    </div>
                </div>
            `;
            
            // Display the analytics
            if (data) {
                data.innerHTML = analyticsHtml;
                data.style.display = 'block';
            }
            if (loading) loading.style.display = 'none';
            
        } catch (error) {
            console.error('Analytics loading error:', error);
            if (data) {
                data.innerHTML = `
                    <div style="color: var(--error-text); text-align: center; padding: 20px; background: var(--error-bg); border-radius: 8px; margin: 20px;">
                        ‚ùå Errore nel caricamento delle statistiche: ${error.message}
                        <br><br>
                        <button onclick="loadAnalytics()" style="background: #22d3ee; color: #0f172a; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 10px;">
                            üîÑ Riprova
                        </button>
                    </div>
                `;
                data.style.display = 'block';
            }
            if (loading) loading.style.display = 'none';
        }
    }

    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('desktopComparisonModal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
    // Open Modal Function (Missing)
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'block';
            // Load analytics if it's the analytics modal
            if (modalId === 'analyticsModal') {
                loadAnalytics();
            }
        }
    }

    // Close Modal Function
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
        }
    }
  </script>

  <!-- Analytics Modal for Desktop -->
  <div id="analyticsModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center;">
    <div style="background: var(--card-bg); border-radius: 12px; padding: 24px; max-width: 800px; width: 90%; max-height: 80%; overflow-y: auto; color: var(--text-color);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; color: var(--text-color);">üìä Analytics Dashboard</h2>
        <button onclick="closeModal('analyticsModal')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-color); opacity: 0.7;">&times;</button>
      </div>
      
      <div id="analyticsContent">
        <div id="analyticsLoading" style="text-align: center; padding: 40px;">
          <div style="border: 4px solid var(--input-border); border-top: 4px solid #22d3ee; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 0 auto 20px;"></div>
          <p style="color: var(--text-color); opacity: 0.8;">Caricamento statistiche...</p>
        </div>
        <div id="analyticsData" style="display: none;">
          <!-- Analytics content will be populated here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Player Comparison Modal for Desktop -->
  <div id="desktopComparisonModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; color: #1f2937;">‚öñÔ∏è Confronto Giocatori</h2>
        <button onclick="closeDesktopModal('desktopComparisonModal')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
      </div>
      
      <div style="margin-bottom: 20px;">
        <input id="desktopPlayer1Input" type="text" placeholder="Nome Giocatore 1" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; margin-bottom: 10px; font-size: 14px;">
        <input id="desktopPlayer2Input" type="text" placeholder="Nome Giocatore 2" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; margin-bottom: 15px; font-size: 14px;">
        <button onclick="compareDesktopPlayers()" style="width: 100%; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer;">Confronta Giocatori</button>
      </div>
      
      <div id="desktopComparisonResults" style="margin-top: 20px;"></div>
    </div>
  </div>
</body>
</html>