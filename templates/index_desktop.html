<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FantacalcioAI ‚Äì Aste, Consigli, Roster</title>
  <link rel="icon" type="image/svg+xml" href="/static/assets/favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="/static/styles/fantacalcioai.css">
  <meta name="theme-color" content="#0A84FF">
  <style>
    /* Basic Dark Theme Styles */
    :root {
      --bg-color: #ffffff;
      --text-color: #333333;
      --header-bg: #f8f9fa;
      --card-bg: #ffffff;
      --primary-btn-bg: linear-gradient(135deg, #667eea, #764ba2);
      --primary-btn-text: white;
      --secondary-btn-bg: #e9ecef;
      --secondary-btn-text: #333;
      --input-border: #ced4da;
      --table-header-bg: #e9ecef;
      --table-text: #333;
      --chat-message-user-bg: #667eea;
      --chat-message-assistant-bg: #f1f3f4;
    }

    .dark-theme {
      --bg-color: #1a1a1a;
      --text-color: #e0e0e0;
      --header-bg: #2c2c2c;
      --card-bg: #222222;
      --primary-btn-bg: linear-gradient(135deg, #8a8aff, #a074c4);
      --primary-btn-text: white;
      --secondary-btn-bg: #444444;
      --secondary-btn-text: #e0e0e0;
      --input-border: #555555;
      --table-header-bg: #333333;
      --table-text: #e0e0e0;
      --chat-message-user-bg: #8a8aff;
      --chat-message-assistant-bg: #333333;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }

    .header {
      background-color: var(--header-bg);
      transition: background-color 0.3s;
    }

    .card {
      background-color: var(--card-bg);
      transition: background-color 0.3s;
    }

    .btn.primary {
      background: var(--primary-btn-bg);
      color: var(--primary-btn-text);
    }

    .btn.ghost {
      background: var(--secondary-btn-bg);
      color: var(--secondary-btn-text);
      border: 1px solid var(--secondary-btn-text);
    }

    .btn.cta, .btn.primary {
        background: var(--primary-btn-bg);
        color: var(--primary-btn-text);
    }

    .btn.ghost {
        background: var(--secondary-btn-bg);
        color: var(--secondary-btn-text);
        border: 1px solid var(--secondary-btn-text);
    }

    input, select, textarea {
      border: 1px solid var(--input-border);
      background-color: var(--card-bg);
      color: var(--text-color);
    }
    input:focus, select:focus, textarea:focus {
        border-color: var(--fcai-primary); /* Assuming --fcai-primary is defined elsewhere or default blue */
        outline: none;
    }

    .table th {
      background-color: var(--table-header-bg);
      color: var(--table-text);
    }

    .chat-container .chat-header {
      background: var(--header-bg);
      border-bottom: 1px solid var(--input-border);
    }

    .chat-container .chat-header span {
      color: var(--text-color);
      opacity: 0.8;
    }

    #desktopChatMessages div {
      background: var(--chat-message-assistant-bg);
      color: var(--text-color);
    }

    #desktopChatMessages .user-message { /* Custom class for user messages */
      background: var(--chat-message-user-bg);
      color: var(--primary-btn-text);
    }

    #desktopTypingIndicator {
      background: var(--chat-message-assistant-bg);
      color: var(--text-color);
    }

    #searchInput, #desktopMessageInput {
        background-color: var(--card-bg);
        color: var(--text-color);
        border: 1px solid var(--input-border);
    }

    .quick-action-btn {
        background: var(--secondary-btn-bg);
        color: var(--secondary-btn-text);
        border: 1px solid var(--secondary-btn-text);
    }

    .quick-action-btn:hover {
        background: var(--primary-btn-bg);
        color: var(--primary-btn-text);
        border: 1px solid var(--fcai-primary); /* Assuming --fcai-primary is defined */
    }

    .footer {
        background-color: var(--header-bg);
        color: var(--text-color);
        transition: background-color 0.3s;
    }

    /* Adjustments for selected div alignment */
    .hero .container > div:first-child {
        margin-top: 0; /* Reset default top margin */
    }
    .hero .container > div {
        margin-top: 40px; /* Move content higher */
    }
    .hero .container {
        display: flex;
        align-items: flex-start; /* Align items to the top */
        gap: 32px; /* Space between content and card */
    }
    .hero .card.pad {
        margin-top: 0; /* Align card to the top */
        margin-left: auto; /* Push to the right if needed, or remove for left align */
        /* If it needs to align with the table, the table's parent might need adjustment */
    }

    /* Responsive adjustments for hero section */
    @media (max-width: 768px) {
        .hero .container {
            flex-direction: column;
            align-items: center; /* Center items when stacked */
        }
        .hero .card.pad {
            margin-top: 24px; /* Add some space when stacked */
            margin-left: 0;
            width: 100%;
        }
        .hero .container > div {
            margin-top: 0; /* Reset margin when stacked */
        }
    }

    /* Dark Theme Specific Adjustments */
    [data-theme="dark"] body { color: #e5e7eb; }
    [data-theme="light"] body { color: #333; }
    [data-theme="dark"] .container { color: #e5e7eb; }
    [data-theme="light"] .container { color: #333; }

    /* Update message colors for light theme */
    [data-theme="light"] .assistant-message { background: #f1f3f4; color: #222; }
    [data-theme="light"] .typing-indicator { background: #f1f3f4; color: #222; }
    [data-theme="light"] .player-card { background: #ffffff; border-color: #eee; color: #333; }

    /* Fix dark theme for specific elements */
    [data-theme="dark"] .kicker { background: var(--card-bg); border-color: var(--input-border); color: var(--text-color); }
    [data-theme="dark"] .kpi { background: var(--card-bg); border-color: var(--input-border); color: var(--text-color); }
    [data-theme="dark"] .quick-action-btn { color: var(--primary-btn-text) !important; }
    [data-theme="dark"] .table { color: var(--text-color); }
    [data-theme="dark"] .table th { background-color: var(--table-header-bg); color: var(--table-text); }
    [data-theme="dark"] .table td { border-bottom-color: var(--input-border); }
    [data-theme="dark"] .help { color: var(--text-color); opacity: 0.7; }

    /* Additional dark theme fixes */
    [data-theme="dark"] .nav a { color: #e5e7eb; }
    [data-theme="dark"] .nav .brand .word { color: #e5e7eb; }
    [data-theme="dark"] .lead { color: #9ca3af; }
    [data-theme="dark"] .section { background-color: var(--bg-color); }
    [data-theme="dark"] .section.alt { background-color: var(--card-bg); }
    [data-theme="dark"] .chat-container { background-color: var(--card-bg); border-color: var(--input-border); }
    [data-theme="dark"] .chat-header { background-color: var(--header-bg); color: var(--text-color); }
    [data-theme="dark"] #desktopChatMessages div { background: var(--chat-message-assistant-bg); color: var(--text-color); }
    [data-theme="dark"] #desktopTypingIndicator { background: var(--chat-message-assistant-bg); color: var(--text-color); }
    [data-theme="dark"] h1, [data-theme="dark"] h2, [data-theme="dark"] h3, [data-theme="dark"] h4 { color: var(--text-color); }
    [data-theme="dark"] .footer { background-color: var(--header-bg); color: var(--text-color); }

  </style>
</head>
<body>
  <header class="header">
    <div class="container nav">
      <a class="brand" href="/">
        <svg width="280" height="68" viewBox="0 0 280 48" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-labelledby="title desc">
          <title id="title">FantacalcioAI - Logo</title>
          <desc id="desc">Wordmark con monogramma a scudo, pallone e nodi AI orbitanti</desc>
          <g transform="translate(4,4)">
            <path d="M20 0 L38 6 C38 20 31 31 20 40 C9 31 2 20 2 6 L20 0Z" fill="#0A84FF"/>
            <circle cx="20" cy="18" r="9" fill="white"/>
            <polygon points="20,11 24,14 23,19 17,19 16,14" fill="#0A84FF"/>
            <circle cx="15.5" cy="16.5" r="2" fill="#0A84FF"/>
            <circle cx="24.5" cy="16.5" r="2" fill="#0A84FF"/>
            <circle cx="20" cy="21.5" r="2" fill="#0A84FF"/>
            <path d="M9,12 C20,3 31,10 30,19" stroke="#72E3A6" stroke-width="1.5" fill="none"/>
            <circle cx="9" cy="12" r="2" fill="#72E3A6"/>
            <circle cx="30" cy="19" r="2" fill="#72E3A6"/>
          </g>
          <g transform="translate(52,12)">
            <text x="0" y="16" font-family="Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif"
                  font-size="22" font-weight="700" fill="var(--fcai-text)" letter-spacing="0.2">
              Fantacalcio
            </text>
            <rect x="111" y="2" width="4" height="22" rx="2" fill="#0A84FF"/>
            <text x="118" y="16" font-family="Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif"
                  font-size="18" font-weight="800" fill="#0A84FF" letter-spacing="0.4">
              AI
            </text>
            <text x="0" y="32" font-family="Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif"
                  font-size="10.5" fill="var(--fcai-text-dim)" letter-spacing="0.3">
              insights ‚Ä¢ aste ‚Ä¢ consigli in tempo reale
            </text>
          </g>
        </svg>
      </a>
      <nav class="spacer"></nav>
      <!-- Login Indicator Placeholder -->
      <span id="login-indicator" style="display: none; margin-right: 10px; font-weight: 600; color: var(--fcai-primary);"></span>
      <a class="btn" href="#funzioni">Funzioni</a>
      <a class="btn" href="/auth/login" style="background: linear-gradient(135deg, #ffd700, #ffed4e); color: #333; font-weight: 700; border: 2px solid #ffd700;">
        <i style="font-size: 14px;">üëë</i> Accedi per PRO!
      </a>
      <a class="btn btn-primary" href="/auth/login">Accedi</a>
      <a class="btn btn-primary" href="/app">Apri App</a>
      <!-- Theme Switcher -->
      <button id="theme-toggle" class="btn toggle" style="margin-left: 10px;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="11"></circle>
          <circle cx="12" cy="12" r="4"></circle>
          <line x1="12" y1="1" x2="12" y2="5"></line>
          <line x1="12" y1="19" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="7.03" y2="7.03"></line>
          <line x1="16.97" y1="16.97" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="5" y2="12"></line>
          <line x1="19" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="7.03" y2="16.97"></line>
          <line x1="16.97" y1="7.03" x2="19.78" y2="4.22"></line>
        </svg>
      </button>
    </div>
  </header>

  <section class="hero">
    <div class="container wrap">
      <div>
        <span class="kicker">‚öΩ + ü§ñ Consigli data-driven</span>
        <h1 class="h1">Aste intelligenti e consigli in tempo reale per la Serie A</h1>
        <p class="lead">Ranking dinamici, budget optimizer, scouting U21 e analisi avversari. Mobile-first, ora anche "website-like".</p>
        <div class="btn-group mt-2">
          <a class="btn cta" href="/app">Apri l'app</a>
          <a class="btn ghost" href="/dashboard">Leghe</a>
        </div>
        <div class="kpis mt-3">
          <div class="kpi"><div class="label">Database giocatori</div><div class="value">800+</div></div>
          <div class="kpi"><div class="label">Ruoli & filtri</div><div class="value">30+</div></div>
          <div class="kpi"><div class="label">Consigli/ora</div><div class="value">‚àû</div></div>
          <div class="kpi"><div class="label">Modalit√†</div><div class="value">Classic ‚Ä¢ Mantra</div></div>
        </div>
      </div>
      <div class="card pad">
        <div class="toolbar">
          <div class="search" style="flex:1">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15a7.5 7.5 0 0 1 0 15z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <input id="searchInput" type="text" placeholder="Cerca giocatori, squadra, ruolo‚Ä¶">
          </div>
          <button class="btn toggle" id="u21Toggle">U21</button>
          <button class="btn toggle active" id="formToggle">In forma</button>
        </div>
        <div class="mt-2">
          <div id="loadingIndicator" class="help">Caricamento dati giocatori...</div>
          <table class="table" id="playersTable" style="display: none;">
            <thead><tr><th>Nome</th><th>Ruolo</th><th>Squadra</th><th>Fantamedia</th><th>Prezzo</th></tr></thead>
            <tbody id="playersTableBody"></tbody>
          </table>
          <div id="playersCount" class="help mt-1"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Enhanced Features Section with 2x2 grid -->
  <section id="funzioni" class="section">
    <div class="container">
      <div class="grid-2" style="gap: 24px; margin-bottom: 32px;">
        <div class="card pad">
          <h2>üéØ Ranking & Fantamedia intelligente</h2>
          <p>Combina fantamedie storiche, xG/xA, forma e calendario. Filtri per ruolo avanzati con analisi predittiva.</p>
          <div class="btn-group mt-2">
            <button onclick="getTopPlayersByRole('A')" class="btn primary">Top Attaccanti</button>
            <button onclick="getTopPlayersByRole('C')" class="btn ghost">Top Centrocampisti</button>
          </div>
        </div>
        <div class="card pad">
          <h2>üí∞ Budget optimizer</h2>
          <p>Strategie d'asta simulate: aggressiva, bilanciata, low-cost con slot e vincoli di lega personalizzati.</p>
          <div class="btn-group mt-2">
            <button onclick="askFormationAdvice('3-5-2')" class="btn primary">Strategia 3-5-2</button>
            <button onclick="askFormationAdvice('4-3-3')" class="btn ghost">Strategia 4-3-3</button>
          </div>
        </div>
      </div>

      <div class="grid-2" style="gap: 24px;">
        <div class="card pad">
          <h2>üë∂ Scouting U21</h2>
          <p>Rileva prospetti con minuti crescenti e valore fantacalcistico in aumento. Algoritmi di machine learning.</p>
          <div class="btn-group mt-2">
            <button onclick="getU21PlayersByRole('A')" class="btn primary">U21 Attaccanti</button>
            <button onclick="getU21PlayersByRole('C')" class="btn ghost">U21 Centrocampisti</button>
          </div>
        </div>
        <div class="card pad">
          <h2>‚ö° Assistenza in tempo reale</h2>
          <p>Suggerimenti live per schieramento, cambi e ballottaggi. Notifiche automatiche sugli infortuni.</p>
          <div class="btn-group mt-2">
            <a class="btn primary" href="/app">Inizia ora</a>
            <button onclick="getTeamAcquisitions('Inter')" class="btn ghost">Acquisti Inter</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Conversational AI Assistant Section -->
  <section class="section">
    <div class="container">
      <h2 style="text-align: center; margin-bottom: 32px;">ü§ñ Assistente AI Conversazionale</h2>
      <div class="card pad" style="max-width: 800px; margin: 0 auto;">
        <div class="chat-container" style="min-height: 400px; border: 1px solid #ddd; border-radius: 12px; padding: 20px; background: #f8f9fa;">
          <div class="chat-header" style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid #e9ecef; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 8px; color: #666;">
              <div style="width: 10px; height: 10px; border-radius: 50%; background: #28a745; animation: pulse 2s infinite;"></div>
              <span>Assistente Online</span>
            </div>
            <div>
              <button onclick="resetDesktopChat()" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px;">Reset Chat</button>
            </div>
          </div>

          <div id="desktopChatMessages" style="min-height: 250px; max-height: 400px; overflow-y: auto; margin-bottom: 16px; scroll-behavior: smooth;">
            <div style="margin-bottom: 12px; padding: 12px 16px; border-radius: 16px; background: #f1f3f4; color: #222; border-bottom-left-radius: 6px; max-width: 85%;">
              üëã Ciao! Sono il tuo assistente FantacalcioAI. Dimmi di cosa hai bisogno per la tua lega!
            </div>
          </div>

          <div id="desktopTypingIndicator" style="display: none; align-items: center; gap: 8px; padding: 10px 16px; background: #f1f3f4; border-radius: 16px; max-width: 200px; margin-bottom: 12px;">
            <div style="display: flex; gap: 4px;">
              <span style="width: 8px; height: 8px; border-radius: 50%; background: #667eea; animation: typing 1.4s infinite;"></span>
              <span style="width: 8px; height: 8px; border-radius: 50%; background: #667eea; animation: typing 1.4s infinite; animation-delay: 0.15s;"></span>
              <span style="width: 8px; height: 8px; border-radius: 50%; background: #667eea; animation: typing 1.4s infinite; animation-delay: 0.3s;"></span>
            </div>
            <span>L'assistente sta scrivendo...</span>
          </div>

          <div style="display: flex; gap: 10px; align-items: flex-end;">
            <textarea id="desktopMessageInput" placeholder="Scrivi la tua domanda..." style="flex: 1; padding: 12px 16px; border: 2px solid #ddd; border-radius: 20px; outline: 0; font-size: 14px; min-height: 50px; resize: vertical; font-family: system-ui;"></textarea>
            <button onclick="sendDesktopMessage()" style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; padding: 12px 18px; border-radius: 20px; cursor: pointer; font-weight: 600;">Invia</button>
          </div>
        </div>

        <!-- Duplicate buttons removed - main quick actions are below -->
      </div>
    </div>
  </section>

  <!-- Working Demo Section -->
  <section class="section alt">
    <div class="container grid-2">
      <div>
        <h2>Un'unica UI per mobile e desktop</h2>
        <p>La stessa base CSS gestisce l'interfaccia "app-like" e il layout "website-like". Meno manutenzione, pi√π consistenza.</p>
        <div class="btn-group mt-2">
          <a class="btn primary" href="/app">Apri App</a>
          <a class="btn" href="#funzioni">Vedi funzioni</a>
        </div>
      </div>
      <div class="card pad">
        <h3>üîß Configurazione Lega</h3>
        <form class="form" onsubmit="return handleLeagueSetup(event)">
          <div>
            <label class="label">Modalit√† di lega</label>
            <select class="select" id="leagueMode"><option>Classic</option><option>Mantra</option><option>Draft</option></select>
          </div>
          <div>
            <label class="label">Budget iniziale</label>
            <input class="input" type="number" id="initialBudget" placeholder="500" value="500"/>
            <div class="help">Valore per squadra</div>
          </div>
          <div>
            <label class="label">Formazione preferita</label>
            <select class="select" id="preferredFormation"><option>3-4-3</option><option>3-5-2</option><option>4-3-3</option><option>4-4-2</option></select>
          </div>
          <button type="submit" class="btn cta">Genera strategia d'asta</button>
        </form>
      </div>
    </div>
  </section>

  <!-- Quick Actions Section -->
  <section class="section alt">
    <div class="container">
      <h2 style="text-align: center; margin-bottom: 32px;">‚ö° Azioni Rapide</h2>
      <div class="quick-actions" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; max-width: 1000px; margin: 0 auto;">
        <button class="quick-action-btn" onclick="askDesktopQuestion('Migliori attaccanti per budget 150 crediti?')">üéØ Top Attaccanti Budget</button>
        <button class="quick-action-btn" onclick="askDesktopQuestion('Top centrocampisti (budget 120)')">‚öΩ Top Centrocampisti</button>
        <button class="quick-action-btn" onclick="askDesktopQuestion('Top difensori (budget 100)')">üõ°Ô∏è Top Difensori</button>
        <button class="quick-action-btn" onclick="askDesktopQuestion('Migliori portieri budget 40')">ü•Ö Top Portieri</button>
        <button class="quick-action-btn" onclick="askDesktopQuestion('Formazione 3-5-2 con budget 500 crediti?')">‚öΩ Formazione 3-5-2</button>
        <button class="quick-action-btn" onclick="askDesktopQuestion('Formazione 4-3-3 (600 crediti)')">‚öΩ Formazione 4-3-3</button>
        <button class="quick-action-btn" onclick="askDesktopQuestion('Formazione 4-5-1 (450 crediti)')">‚öΩ Formazione 4-5-1</button>
        <button class="quick-action-btn" onclick="askDesktopQuestion('Formazione 3-4-3 (550 crediti)')">‚öΩ Formazione 3-4-3</button>
        <button class="quick-action-btn" onclick="askDesktopQuestion('2-3 difensori Under 21')">üë∂ U21 Difensori</button>
        <button class="quick-action-btn" onclick="askDesktopQuestion('3 centrocampisti Under 21')">üë∂ U21 Centrocampisti</button>
        <button class="quick-action-btn" onclick="askDesktopQuestion('2 attaccanti Under 21')">üë∂ U21 Attaccanti</button>
        <button class="quick-action-btn" onclick="askDesktopQuestion('Giovani Under 23 tutti i ruoli')">üë∂ U23 Tutti i Ruoli</button>
        <button class="quick-action-btn" onclick="askDesktopQuestion('Strategia per l\'asta')">üèÜ Strategia Asta</button>
        <button class="quick-action-btn" onclick="askDesktopQuestion('Ultimi acquisti Inter')">üìà Acquisti Inter</button>
        <button class="quick-action-btn" onclick="askDesktopQuestion('Ultimi acquisti Milan')">üìà Acquisti Milan</button>
        <button class="quick-action-btn" onclick="askDesktopQuestion('Ultimi acquisti Juventus')">üìà Acquisti Juventus</button>
        <button class="quick-action-btn" onclick="askDesktopQuestion('Ultimi acquisti Napoli')">üìà Acquisti Napoli</button>
        <button class="quick-action-btn" onclick="askDesktopQuestion('Ultimi acquisti Roma')">üìà Acquisti Roma</button>
        <button class="quick-action-btn" onclick="askDesktopQuestion('Ultimi acquisti Lazio')">üìà Acquisti Lazio</button>
        <button class="quick-action-btn" onclick="askDesktopQuestion('Ultimi acquisti Atalanta')">üìà Acquisti Atalanta</button>
      </div>
    </div>
  </section>

  <!-- Live Player Data Section -->
  <section class="section">
    <div class="container">
      <h2 style="text-align: center; margin-bottom: 32px;">üî• Dati Live Serie A 2025-26</h2>
      <div id="liveDataContainer" class="grid-2" style="gap: 24px;">
        <div class="card pad">
          <h3>‚öΩ Top Attaccanti</h3>
          <div id="topAttackers">Caricamento...</div>
        </div>
        <div class="card pad">
          <h3>üéØ Top Centrocampisti</h3>
          <div id="topMidfielders">Caricamento...</div>
        </div>
      </div>
    </div>
  </section>

  <footer class="footer">
    <div class="container">¬© <span id="y"></span> FantacalcioAI. Tutti i diritti riservati.</div>
  </footer>

  <script>
    document.getElementById('y').textContent=new Date().getFullYear();

    // --- Theme Toggle Functionality ---
    const themeToggle = document.getElementById('theme-toggle');
    const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');

    function toggleTheme(theme) {
      if (theme === 'dark') {
        document.body.classList.add('dark-theme');
        themeToggle.classList.add('active'); // Indicate dark mode is active
      } else {
        document.body.classList.remove('dark-theme');
        themeToggle.classList.remove('active'); // Indicate light mode is active
      }
      localStorage.setItem('theme', theme);
    }

    function checkAndApplyTheme() {
      let savedTheme = localStorage.getItem('theme');
      if (!savedTheme && prefersDarkScheme.matches) {
        savedTheme = 'dark';
      }
      toggleTheme(savedTheme || 'light');
    }

    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        const currentTheme = document.body.classList.contains('dark-theme') ? 'light' : 'dark';
        toggleTheme(currentTheme);
      });
    }

    // Apply theme on load
    checkAndApplyTheme();

    // --- Login Indicator (Placeholder) ---
    // In a real app, this would be populated based on user session/token.
    // For demonstration, we'll add a simple way to show it via JS.
    function setLoginStatus(isLoggedIn) {
      const loginIndicator = document.getElementById('login-indicator');
      if (loginIndicator) {
        if (isLoggedIn) {
          loginIndicator.textContent = 'Sei loggato'; // Example text
          loginIndicator.style.display = 'inline';
          // Hide actual login buttons if logged in
          const loginBtn = document.querySelector('a[href="/auth/login"]');
          if (loginBtn) loginBtn.style.display = 'none';
          const proLoginBtn = document.querySelector('a[href="/auth/login"][style*="background: linear-gradient"]');
          if (proLoginBtn) proLoginBtn.style.display = 'none';
        } else {
          loginIndicator.style.display = 'none';
          // Show actual login buttons if not logged in
          const loginBtn = document.querySelector('a[href="/auth/login"]');
          if (loginBtn) loginBtn.style.display = '';
          const proLoginBtn = document.querySelector('a[href="/auth/login"][style*="background: linear-gradient"]');
          if (proLoginBtn) proLoginBtn.style.display = '';
        }
      }
    }
    // Example: Simulate login status (replace with actual logic)
    // setLoginStatus(true); // Uncomment to simulate logged in state


    // Desktop Chat Functionality
    async function sendDesktopMessage() {
        console.log('sendDesktopMessage called');
        const input = document.getElementById('desktopMessageInput');
        const container = document.getElementById('desktopChatMessages');
        const typing = document.getElementById('desktopTypingIndicator');

        if (!input || !container) {
            console.error('Required elements not found:', { input: !!input, container: !!container });
            return;
        }

        const message = input.value.trim();
        console.log('Message to send:', message);
        if (!message) return;

        // Add user message
        const userMsg = document.createElement('div');
        userMsg.style.cssText = `
            margin-bottom: 12px; padding: 12px 16px; border-radius: 16px; max-width: 85%;
            margin-left: auto; border-bottom-right-radius: 6px;
            background: #667eea; color: white;
            text-align: right;
        `;
        userMsg.textContent = message;
        container.appendChild(userMsg);

        // Clear input and scroll
        input.value = '';
        container.scrollTop = container.scrollHeight;

        // Show typing indicator
        if (typing) {
            typing.style.display = 'flex';
        }

        try {
            console.log('Sending request to /api/chat');
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message, mode: 'classic' })
            });

            console.log('Response status:', response.status);

            // Hide typing indicator
            if (typing) {
                typing.style.display = 'none';
            }

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('Response data:', data);

            // Add assistant response
            const assistantMsg = document.createElement('div');
            assistantMsg.style.cssText = `
                margin-bottom: 12px; padding: 12px 16px; border-radius: 16px; max-width: 85%;
                background: #f1f3f4; color: #222; border-bottom-left-radius: 6px;
            `;
            assistantMsg.innerHTML = data.response || 'Risposta non disponibile';
            container.appendChild(assistantMsg);

            container.scrollTop = container.scrollHeight;

        } catch (error) {
            console.error('Chat error:', error);
            
            // Hide typing indicator
            if (typing) {
                typing.style.display = 'none';
            }

            const errorMsg = document.createElement('div');
            errorMsg.style.cssText = `
                margin-bottom: 12px; padding: 12px 16px; border-radius: 16px; max-width: 85%;
                background: #ffebee; color: #c62828; border-bottom-left-radius: 6px;
            `;
            errorMsg.innerHTML = '‚ùå Errore di connessione: ' + error.message;
            container.appendChild(errorMsg);

            container.scrollTop = container.scrollHeight;
        }
    }

    function askDesktopQuestion(question) {
        console.log('askDesktopQuestion called with:', question);
        
        // Prevent multiple calls by checking if already processing
        if (window.isProcessingQuestion) {
            console.log('Already processing a question, ignoring duplicate call');
            return;
        }
        
        window.isProcessingQuestion = true;
        
        const input = document.getElementById('desktopMessageInput');
        if (!input) {
            console.error('Desktop message input not found');
            window.isProcessingQuestion = false;
            return;
        }
        
        input.value = question;
        console.log('Input value set to:', input.value);
        sendDesktopMessage();
        
        // Reset the processing flag after the request completes
        setTimeout(() => {
            window.isProcessingQuestion = false;
        }, 2000);
    }

    function resetDesktopChat() {
        const container = document.getElementById('desktopChatMessages');
        if (container) {
            container.innerHTML = `
                <div style="margin-bottom: 12px; padding: 12px 16px; border-radius: 16px; background: #f1f3f4; color: #222; border-bottom-left-radius: 6px; max-width: 85%;">
                    üëã Ciao! Sono il tuo assistente FantacalcioAI. Dimmi di cosa hai bisogno per la tua lega!
                </div>
            `;
        }
    }

    // Test function to verify quick actions are working
    function testQuickAction() {
        console.log('testQuickAction called');
        alert('Quick actions are working!');
        askDesktopQuestion('Ciao, funzioni correttamente?');
    }

    // Add enter key support for desktop chat
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded - setting up desktop chat');
        const desktopInput = document.getElementById('desktopMessageInput');
        if (desktopInput) {
            console.log('Desktop input found, adding event listener');
            desktopInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendDesktopMessage();
                }
            });
        } else {
            console.error('Desktop input not found during DOMContentLoaded');
        }
    });

    // Add CSS animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.55; }
        }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }
    `;
    document.head.appendChild(style);

    // Desktop App Functionality - Real API Integration
    let currentRole = 'all';
    let playersData = [];

    // Load real player data when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadPlayersData();
        setupEventListeners();
        loadLiveData();
    });

    function setupEventListeners() {
        // Search functionality with debouncing
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            let searchTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    filterAndDisplayPlayers();
                }, 300);
            });
        }

        // Toggle buttons
        const u21Toggle = document.getElementById('u21Toggle');
        const formToggle = document.getElementById('formToggle');

        if (u21Toggle) {
            u21Toggle.addEventListener('click', function() {
                this.classList.toggle('active');
                filterAndDisplayPlayers();
            });
        }

        if (formToggle) {
            formToggle.addEventListener('click', function() {
                this.classList.toggle('active');
                filterAndDisplayPlayers();
            });
        }
    }

    async function loadPlayersData() {
        await searchPlayers();
    }

    async function searchPlayers() {
        try {
            const searchInputEl = document.getElementById('searchInput');
            const searchQuery = searchInputEl ? searchInputEl.value : '';
            const u21ToggleEl = document.getElementById('u21Toggle');
            const isU21Active = u21ToggleEl ? u21ToggleEl.classList.contains('active') : false;
            const formToggleEl = document.getElementById('formToggle');
            const isFormActive = formToggleEl ? formToggleEl.classList.contains('active') : false;

            const params = new URLSearchParams();
            if (searchQuery) params.append('search', searchQuery);
            if (isU21Active) params.append('u21', 'true');
            if (isFormActive) params.append('in_forma', 'true');
            params.append('limit', '20');

            const response = await fetch(`/api/players?${params.toString()}`);
            const data = await response.json();

            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }

            const table = document.getElementById('playersTable');
            if (table) {
                table.style.display = 'table';
            }

            const players = data.players || [];
            displayPlayers(players);
            updatePlayersCount(players.length, data.total || 0);

        } catch (error) {
            console.error('Error loading players data:', error);
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.textContent = 'Errore nel caricamento dei dati. Riprova pi√π tardi.';
            }
        }
    }

    function filterAndDisplayPlayers() {
        searchPlayers();
    }

    function displayPlayers(players) {
        const tbody = document.getElementById('playersTableBody');
        if (!tbody) return;

        tbody.innerHTML = players.map(player => `
            <tr>
                <td><strong>${player.display_name || player.name}</strong></td>
                <td><span style="padding: 4px 8px; border-radius: 8px; font-size: 12px; font-weight: bold; color: white; background: ${getRoleColor(player.role)}">${player.role}</span></td>
                <td>${player.team}</td>
                <td>${player.fantamedia || 0}</td>
                <td>‚Ç¨${player.price || 0}</td>
            </tr>
        `).join('');
    }

    function updatePlayersCount(displayed, total) {
        const countElement = document.getElementById('playersCount');
        if (countElement) {
            countElement.textContent = `Visualizzati ${displayed} di ${total} giocatori trovati - dati reali da FantacalcioAI`;
        }
    }

    function getRoleColor(role) {
        const colors = {
            'P': '#22C55E',
            'D': '#3B82F6',
            'C': '#F59E0B',
            'A': '#EF4444'
        };
        return colors[role] || '#6B7280';
    }

    function showQuickResult(title, message) {
        const resultDiv = document.createElement('div');
        resultDiv.style.cssText = `
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 24px; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px; z-index: 1000; color: #333; font-family: system-ui;
        `;
        resultDiv.innerHTML = `
            <h3 style="margin: 0 0 16px 0; color: #667eea;">${title}</h3>
            <p style="margin: 0 0 20px 0; line-height: 1.6;">${message}</p>
            <button onclick="this.parentElement.remove(); document.getElementById('overlay').remove()" 
                    style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">Chiudi</button>
        `;

        const overlay = document.createElement('div');
        overlay.id = 'overlay';
        overlay.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 999;
        `;
        overlay.onclick = () => { resultDiv.remove(); overlay.remove(); };

        document.body.appendChild(overlay);
        document.body.appendChild(resultDiv);
    }

    async function getTopPlayersByRole(role) {
        try {
            const response = await fetch(`/api/players?role=${role}&in_forma=true&limit=5`);
            const data = await response.json();
            const players = data.players || [];

            const roleNames = { 'A': 'Attaccanti', 'C': 'Centrocampisti', 'D': 'Difensori', 'P': 'Portieri' };
            const roleName = roleNames[role] || 'Giocatori';

            if (players.length > 0) {
                const playersList = players.map(p => `${p.display_name || p.name} (${p.team}, FM ${p.fantamedia})`).join(', ');
                showQuickResult(`üéØ Top ${roleName}`, `I migliori ${roleName.toLowerCase()} in forma: ${playersList}`);
            } else {
                showQuickResult(`üéØ Top ${roleName}`, `Nessun ${roleName.toLowerCase()} trovato in questo momento.`);
            }
        } catch (error) {
            showQuickResult('‚ùå Errore', 'Errore nel caricamento dei dati. Riprova pi√π tardi.');
        }
    }

    async function getU21PlayersByRole(role) {
        try {
            const response = await fetch(`/api/players?role=${role}&u21=true&limit=5`);
            const data = await response.json();
            const players = data.players || [];

            const roleNames = { 'A': 'Attaccanti', 'C': 'Centrocampisti', 'D': 'Difensori', 'P': 'Portieri' };
            const roleName = roleNames[role] || 'Giocatori';

            if (players.length > 0) {
                const playersList = players.map(p => `${p.display_name || p.name} (${p.team})`).join(', ');
                showQuickResult(`üë∂ U21 ${roleName}`, `I migliori ${roleName.toLowerCase()} Under 21: ${playersList}`);
            } else {
                showQuickResult(`üë∂ U21 ${roleName}`, `Nessun ${roleName.toLowerCase()} Under 21 trovato in questo momento.`);
            }
        } catch (error) {
            showQuickResult('‚ùå Errore', 'Errore nel caricamento dei dati. Riprova pi√π tardi.');
        }
    }

    async function askFormationAdvice(formation) {
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: `Consigli per formazione ${formation}` })
            });
            const data = await response.json();
            showQuickResult(`‚öΩ Formazione ${formation}`, data.response || 'Consigli per formazione non disponibili al momento.');
        } catch (error) {
            showQuickResult('‚ùå Errore', 'Errore nel caricamento dei consigli. Riprova pi√π tardi.');
        }
    }

    async function getTeamAcquisitions(team) {
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: `Ultimi acquisti ${team}` })
            });
            const data = await response.json();
            showQuickResult(`üìà Acquisti ${team}`, data.response || 'Informazioni sugli acquisti non disponibili al momento.');
        } catch (error) {
            showQuickResult('‚ùå Errore', 'Errore nel caricamento delle informazioni. Riprova pi√π tardi.');
        }
    }

    function handleLeagueSetup(event) {
        event.preventDefault();
        const mode = document.getElementById('leagueMode').value;
        const budget = document.getElementById('initialBudget').value;
        const formation = document.getElementById('preferredFormation').value;

        showQuickResult(
            'üèÜ Strategia Personalizzata', 
            `Modalit√†: ${mode} | Budget: ‚Ç¨${budget} | Formazione: ${formation}<br><br>` +
            `‚úÖ Strategia consigliata: concentra il 60% del budget sui top player, diversifica per ruolo, ` +
            `punta sui giovani U21 per il futuro. Inizia con la formazione ${formation} e adatta in base agli acquisti.`
        );
        return false;
    }

    // Test function to verify quick actions are working
    function testQuickAction() {
        console.log('Quick action test successful!');
        askDesktopQuestion('Ciao, funzioni correttamente?');
    }

    async function askQuickQuestion(question) {
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: question, mode: 'classic' })
            });
            const data = await response.json();
            showQuickResult('ü§ñ Risposta FantacalcioAI', data.response || 'Risposta non disponibile al momento.');
        } catch (error) {
            showQuickResult('‚ùå Errore', 'Errore nella comunicazione con l\'assistente. Riprova pi√π tardi.');
        }
    }

    async function loadLiveData() {
        try {
            // Load top attackers
            const attackersResponse = await fetch('/api/players?role=A&in_forma=true&limit=3');
            const attackersData = await attackersResponse.json();
            const topAttackers = attackersData.players || [];

            // Load top midfielders
            const midfieldersResponse = await fetch('/api/players?role=C&in_forma=true&limit=3');
            const midfieldersData = await midfieldersResponse.json();
            const topMidfielders = midfieldersData.players || [];

            // Display top attackers
            const attackersContainer = document.getElementById('topAttackers');
            if (attackersContainer && topAttackers.length > 0) {
                attackersContainer.innerHTML = topAttackers.map((player, index) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee;">
                        <div>
                            <strong>${player.display_name || player.name}</strong><br>
                            <small style="color: #666;">${player.team}</small>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: bold; color: #EF4444;">FM ${player.fantamedia}</div>
                            <div style="font-size: 12px; color: #666;">‚Ç¨${player.price}</div>
                        </div>
                    </div>
                `).join('');
            }

            // Display top midfielders
            const midfieldersContainer = document.getElementById('topMidfielders');
            if (midfieldersContainer && topMidfielders.length > 0) {
                midfieldersContainer.innerHTML = topMidfielders.map((player, index) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee;">
                        <div>
                            <strong>${player.display_name || player.name}</strong><br>
                            <small style="color: #666;">${player.team}</small>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: bold; color: #F59E0B;">FM ${player.fantamedia}</div>
                            <div style="font-size: 12px; color: #666;">‚Ç¨${player.price}</div>
                        </div>
                    </div>
                `).join('');
            }

        } catch (error) {
            console.error('Error loading live data:', error);
        }
    }
  </script>
</body>
</html>