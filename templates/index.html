<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ t.title }}</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    :root{
      --tabbar-bg:#0b1220;        /* barra tab sempre scura */
      --tab-inactive-bg:#0e1626;  /* tab non attivi: scuri */
      --tab-inactive-fg:#d1d5db;  /* testo tab non attivi */
      --tab-border:#1f2937;       /* separatori */
      --tab-active-fg:#22d3ee;    /* testo tab attivo */
      --tab-active-underline:#22d3ee;

      --classic-page-bg:#ffffff;  /* contenuto Classic */
      --classic-card-bg:#ffffff;

      --dark-page-bg:#0b1220;     /* contenuto modalitÃ  scure */
      --dark-card-bg:#0f172a;
      --bubble-dark:#1f2937;

      --accent:#00c851;
    }

    /* Reset */
    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg,#2c3e50 0%,#34495e 100%);
      color:#333;
      min-height:100vh;
      overflow-x:hidden;
    }

    .container{
      max-width:500px;
      margin:0 auto;
      background: var(--classic-page-bg);
      border-radius:15px;
      box-shadow:0 10px 30px rgba(0,0,0,.2);
      overflow:hidden;
      min-height:90vh;
      display:flex;
      flex-direction:column;
    }

    .header{
      background: linear-gradient(45deg,#00c851,#007e33);
      color:#fff;
      padding:15px 20px;
      position:relative;
      z-index:6;
    }
    .header h1{font-size:1.25rem;margin-bottom:6px}
    .header p{opacity:.9;font-size:.9rem}
    .header .actions{
      position:absolute;top:12px;right:12px;display:flex;gap:8px
    }
    .header-btn{
      background:rgba(255,255,255,.2);border:0;color:#fff;
      padding:6px 10px;border-radius:14px;cursor:pointer;font-size:.8rem
    }
    .header-btn.active{background:rgba(255,255,255,.4)}

    /* ====== TABS: SEMPRE SCURI ====== */
    .tabs{
      display:flex;
      position:sticky; top:0; z-index:5;
      background: var(--tabbar-bg);
      border-bottom:1px solid var(--tab-border);
      box-shadow: inset 0 -1px 0 rgba(0,0,0,.25);
    }
    .tabs .swipe-hint{
      display:none; width:100%; text-align:center; color:#9ca3af;
      font-size:.75rem; padding:6px 8px; background:rgba(255,255,255,.03)
    }
    .tab{
      flex:1; padding:12px 8px; text-align:center; cursor:pointer;
      background: var(--tab-inactive-bg);
      color: var(--tab-inactive-fg);
      font-weight:600; font-size:.9rem; border:0;
      border-right:1px solid var(--tab-border);
      transition: color .15s ease, background .15s ease, border-color .15s ease;
      opacity:1; /* forzato per visibilitÃ  */
    }
    .tab:last-child{border-right:0}
    .tab.active{
      background: var(--tabbar-bg);
      color: var(--tab-active-fg);
      box-shadow: inset 0 -3px 0 var(--tab-active-underline);
    }
    .tab:focus{outline:2px solid var(--tab-active-underline)}

    /* Contenuti tab */
    .tab-content{display:none;flex:1;overflow:hidden}
    .tab-content.active{display:flex!important;flex-direction:column}

    .league-setup{
      padding:15px 20px;border-bottom:1px solid #eee;
      display:flex;flex-wrap:wrap;gap:10px;align-items:center
    }
    .league-setup select,.league-setup input{
      padding:8px 12px;border:1px solid #ddd;border-radius:20px;font-size:.9rem;flex:1;min-width:80px
    }

    .chat-container{flex:1;display:flex;flex-direction:column;padding:20px}
    .chat-header{
      display:flex;justify-content:space-between;align-items:center;
      padding-bottom:12px;border-bottom:1px solid #e9ecef;margin-bottom:12px
    }
    .status-indicator{display:flex;align-items:center;gap:8px;color:#666}
    .status-dot{width:10px;height:10px;border-radius:50%;background:#28a745;animation:pulse 2s infinite}

    .chat-messages{flex:1;overflow-y:auto;padding:10px 0;margin-bottom:16px;scroll-behavior:smooth;max-height:400px}
    .message{margin-bottom:12px;padding:12px 16px;border-radius:16px;max-width:82%;animation:fadeIn .25s ease}
    .user-message{background:#667eea;color:#fff;margin-left:auto;border-bottom-right-radius:6px}
    .assistant-message{background:#f1f3f4;color:#222;border-bottom-left-radius:6px}

    .typing-indicator{
      display:none;align-items:center;gap:8px;padding:10px 16px;background:#f1f3f4;border-radius:16px;max-width:200px;margin-bottom:12px
    }
    .typing-dots{display:flex;gap:4px}
    .typing-dots span{width:8px;height:8px;border-radius:50%;background:#667eea;animation:typing 1.4s infinite}
    .typing-dots span:nth-child(2){animation-delay:.15s}
    .typing-dots span:nth-child(3){animation-delay:.3s}

    .input-wrapper{display:flex;gap:10px;align-items:flex-end}
    #messageInput,#messageInputMantra,#messageInputDraft,#messageInputSuper{
      flex:1;padding:16px 18px;border:2px solid #ddd;border-radius:22px;outline:0;font-size:16px;min-height:56px;resize:vertical
    }
    #messageInput:focus,#messageInputMantra:focus,#messageInputDraft:focus,#messageInputSuper:focus{border-color:#00c851}
    .btn{padding:12px 18px;border:0;border-radius:22px;cursor:pointer;font-weight:700;transition:transform .15s ease, box-shadow .15s ease}
    .btn-primary{background:linear-gradient(45deg,#00c851,#007e33);color:#fff}
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(0,200,81,.28)}
    .btn-secondary{background:#6c757d;color:#fff;font-size:.85rem;padding:8px 14px}

    .quick-actions{
      padding:16px;border-top:1px solid #f0f0f0;background:#e9ecef;
      display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;align-items:stretch
    }
    .quick-action-btn{
      background:linear-gradient(135deg,#00c851,#007e33)!important;border:2px solid #00c851!important;border-radius:14px;
      padding:10px 14px;font-size:.85rem;color:#fff!important;font-weight:600;box-shadow:0 2px 4px rgba(0,200,81,.2);
      text-align:center;display:flex;align-items:center;justify-content:center;min-height:42px;cursor:pointer;
      transition:transform .15s ease,box-shadow .15s ease
    }
    .quick-action-btn:hover{
      transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,200,81,.3)
    }

    /* Section for Historical Stats */
    .search-container{padding:20px}
    .search-header{display:flex;gap:10px;margin-bottom:12px}
    .search-header input{
      flex:1;padding:12px 15px;border:2px solid #e1e8ed;border-radius:20px;font-size:16px;outline:0
    }
    .filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .filter-btn{
      padding:6px 12px;border:2px solid var(--accent);background:#f8f9fa;color:var(--accent);
      border-radius:14px;font-size:.8rem;font-weight:600;cursor:pointer
    }

    .player-card{background:var(--classic-card-bg);border:1px solid #eee;border-radius:12px;padding:14px;margin-bottom:10px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .player-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .player-name{font-weight:700;color:#333}
    .player-role{background:var(--accent);color:#fff;padding:3px 8px;border-radius:10px;font-size:.7rem;margin-left:auto}
    .player-details{display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:.9rem;color:#555}

    /* Modal */
    .modal{position:fixed;z-index:1000;inset:0;background:rgba(0,0,0,.7);display:none}
    .modal.show{display:block}
    .modal-content{
      background:#111827;color:#e5e7eb;margin:5% auto;padding:20px;border-radius:12px;width:90%;max-width:600px;max-height:80vh;overflow:auto;
      box-shadow:0 8px 32px rgba(0,0,0,.35)
    }
    .close{color:#9ca3af;float:right;font-size:28px;font-weight:700;cursor:pointer}
    .close:hover{color:#fff}

    /* Comparison */
    .comparison-table{width:100%;margin:16px 0;border-collapse:collapse}
    .comparison-header{display:grid;grid-template-columns:150px repeat(auto-fit,minmax(120px,1fr));background:#0f172a;color:#e5e7eb;font-weight:700;border-bottom:2px solid #1f2937}
    .comparison-row{display:grid;grid-template-columns:150px repeat(auto-fit,minmax(120px,1fr));border-bottom:1px solid #1f2937}
    .comparison-metric,.comparison-player,.comparison-value{padding:10px;text-align:left;border-right:1px solid #1f2937}
    .comparison-metric{background:#0b1220}
    .comparison-player{font-weight:700;color:#22d3ee}
    .comparison-summary{margin-top:14px;padding:12px;background:#0b1220;border-left:4px solid #22d3ee;border-radius:6px;color:#e5e7eb}

    /* Mantra/Draft/Superscudetto: contenuto scuro */
    body.mode-mantra .container,
    body.mode-draft .container,
    body.mode-superscudetto .container{
      background: var(--dark-page-bg);
      color:#e5e7eb;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    body.mode-mantra .assistant-message,
    body.mode-draft .assistant-message,
    body.mode-superscudetto .assistant-message{
      background: var(--bubble-dark); color:#e5e7eb;
    }
    body.mode-mantra .typing-indicator,
    body.mode-draft .typing-indicator,
    body.mode-superscudetto .typing-indicator{
      background: var(--bubble-dark); color:#e5e7eb;
    }
    body.mode-mantra .player-card,
    body.mode-draft .player-card,
    body.mode-superscudetto .player-card{
      background: var(--dark-card-bg); border-color:#1f2937; color:#e5e7eb;
    }

    /* Animations */
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.55}}
    @keyframes typing{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-8px)}}

    /* Mobile tweaks */
    @media (max-width:768px){
      .container{border-radius:0;min-height:100vh}
      .tabs{overflow-x:auto; white-space:nowrap; -webkit-overflow-scrolling:touch}
      .tabs .swipe-hint{display:block}
      .tab{min-width:100px; flex-shrink:0}
      .quick-actions{
        grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;padding:12px
      }
      .quick-action-btn{
        padding:8px 10px;font-size:.8rem;min-height:38px
      }
    }
    
    /* Ensure tabs are always visible */
    .tabs{
      display:flex;
      position:sticky; top:0; z-index:5;
      background: var(--tabbar-bg);
      border-bottom:1px solid var(--tab-border);
      box-shadow: inset 0 -1px 0 rgba(0,0,0,.25);
      min-height:48px;
    }
    .tab{
      flex:1; padding:12px 8px; text-align:center; cursor:pointer;
      background: var(--tab-inactive-bg);
      color: var(--tab-inactive-fg);
      font-weight:600; font-size:.85rem; border:0;
      border-right:1px solid var(--tab-border);
      transition: color .15s ease, background .15s ease, border-color .15s ease;
      opacity:1;
      min-width:90px;
    }

    /* Specific styles for Historical Stats */
    .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }
      .player-card {
        background: rgba(255,255,255,0.02);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 8px;
        padding: 15px;
        transition: all 0.3s ease;
        position: relative;
      }
      .player-card:hover {
        border-color: rgba(0,255,136,0.3);
        transform: translateY(-2px);
      }
      .player-card h4 {
        color: #00ff88;
        margin: 0 0 10px 0;
        font-size: 16px;
      }
      .player-card p {
        margin: 5px 0;
        font-size: 13px;
        color: #ccc;
      }

      /* Historical Stats Styles */
      .stats-overview {
        margin-bottom: 25px;
        padding: 20px;
        background: rgba(0,255,136,0.05);
        border-radius: 12px;
        border: 1px solid rgba(0,255,136,0.2);
      }
      .stats-overview h3 {
        color: #00ff88;
        margin: 0 0 15px 0;
      }
      .stats-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }
      .stat-item {
        padding: 10px;
        background: rgba(255,255,255,0.03);
        border-radius: 6px;
        text-align: center;
      }

      .stats-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        padding-bottom: 10px;
      }
      .stats-tab {
        padding: 10px 20px;
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 6px;
        color: #ccc;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .stats-tab:hover {
        background: rgba(0,255,136,0.1);
        border-color: rgba(0,255,136,0.3);
      }
      .stats-tab.active {
        background: rgba(0,255,136,0.2);
        border-color: #00ff88;
        color: #00ff88;
      }

      .stats-content {
        display: none;
      }
      .stats-content.active {
        display: block;
      }

      .rank {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #00ff88;
        color: #000;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
      }

      .top-performer .rank {
        background: linear-gradient(45deg, #ff6b35, #f7931e);
      }
      .best-value .rank {
        background: linear-gradient(45deg, #4facfe, #00f2fe);
      }

      .highlight {
        color: #00ff88;
        font-weight: bold;
      }

      .role-stats {
        margin-bottom: 20px;
        padding: 15px;
        background: rgba(255,255,255,0.02);
        border-radius: 8px;
        border-left: 4px solid #00ff88;
      }
      .role-stats h5 {
        color: #00ff88;
        margin: 0 0 10px 0;
      }
      .role-summary {
        display: flex;
        gap: 20px;
        margin-bottom: 10px;
        font-size: 14px;
      }
      .role-top {
        font-size: 13px;
        color: #aaa;
      }

      .search-results h4 {
        color: #00ff88;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
      }
  </style>
</head>
<body class="mode-classic">
  <!-- Modals -->
  <div id="analyticsModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('analyticsModal')">&times;</span>
      <h2>ğŸ“Š Analytics</h2>
      <div id="analyticsContent">
        <p style="opacity:.8">Coming soonâ€¦</p>
      </div>
    </div>
  </div>

  <div id="comparisonModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('comparisonModal')">&times;</span>
      <h2>âš–ï¸ Player Comparison</h2>
      <div class="comparison-inputs" style="margin:10px 0 6px">
        <input id="player1Input" placeholder="Player 1" style="margin-bottom:8px;padding:10px;width:100%;border-radius:8px;border:1px solid #334155;background:#0b1220;color:#e5e7eb">
        <input id="player2Input" placeholder="Player 2" style="margin-bottom:8px;padding:10px;width:100%;border-radius:8px;border:1px solid #334155;background:#0b1220;color:#e5e7eb">
        <button onclick="comparePlayersModal()" class="btn btn-primary" style="width:100%">Compare</button>
      </div>
      <div id="comparisonResults" style="margin-top:12px;"></div>
    </div>
  </div>

  <div class="container">
    <div class="header">
      <div class="actions">
        <button onclick="switchLang('it')" class="header-btn {{ 'active' if lang == 'it' else '' }}">IT</button>
        <button onclick="switchLang('en')" class="header-btn {{ 'active' if lang == 'en' else '' }}">EN</button>
        <button onclick="openModal('analyticsModal')" class="header-btn">ğŸ“Š</button>
        <button onclick="openModal('comparisonModal')" class="header-btn">âš–ï¸</button>
      </div>
      <h1>ğŸ† {{ t.title }}</h1>
      <p>{{ t.subtitle }}</p>
    </div>

    <!-- TAB BAR (sempre scura) -->
    <div class="tabs">
      <div class="swipe-hint">â† Scorri per vedere tutte le modalitÃ  â†’</div>
      <button class="tab active" onclick="switchTab('classic', this)">Classic</button>
      <button class="tab" onclick="switchTab('mantra', this)">Mantra</button>
      <button class="tab" onclick="switchTab('draft', this)">Draft</button>
      <button class="tab" onclick="switchTab('superscudetto', this)">Superscudetto</button>
      <button class="tab" onclick="switchTab('historical', this)">Statistiche</button>
    </div>

    <!-- Classic -->
    <div class="tab-content active" id="classic">
      <div class="league-setup">
        <input type="number" id="participants" placeholder="{{ t.participants }}" value="8" min="4" max="20">
        <input type="number" id="budget" placeholder="{{ t.budget }}" value="500" min="100" max="1000">
        <button class="btn btn-secondary" onclick="resetChat()">{{ t.reset_chat }}</button>
        <button class="btn btn-secondary" onclick="testAPI()" style="background: #dc3545;">ğŸ”§ Test API</button>
      </div>

      <div class="chat-container">
        <div class="chat-header">
          <div class="status-indicator" id="statusIndicator">
            <span class="status-dot"></span><span>Assistente Online</span>
          </div>
        </div>

        <div class="chat-messages" id="chatContainer">
          <div class="message assistant-message">
            ğŸ‘‹ {{ t.welcome }}<br><br>ModalitÃ  <strong>Classic</strong> attiva. Dimmi di cosa hai bisogno!
          </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
          <div class="typing-dots"><span></span><span></span><span></span></div>
          <span>L'assistente sta scrivendo...</span>
        </div>

        <div class="input-wrapper">
          <textarea id="messageInput" placeholder="Scrivi la tua domanda..." maxlength="500" rows="3"></textarea>
          <button class="btn btn-primary" onclick="sendMessage('classic')" id="sendBtn">{{ t.send }}</button>
        </div>
      </div>

      <div class="quick-actions">
        <button class="quick-action-btn" onclick="askQuickQuestion('Migliori attaccanti per budget 150 crediti?')">ğŸ¯ Top Attaccanti Budget</button>
        <button class="quick-action-btn" onclick="askQuickQuestion('Top centrocampisti (budget 120)')">âš½ Top Centrocampisti</button>
        <button class="quick-action-btn" onclick="askQuickQuestion('Top difensori (budget 100)')">ğŸ›¡ï¸ Top Difensori</button>
        <button class="quick-action-btn" onclick="askQuickQuestion('Migliori portieri budget 40')">ğŸ¥… Top Portieri</button>
        <button class="quick-action-btn" onclick="askQuickQuestion('Formazione 3-5-2 con budget 500 crediti?')">âš½ Formazione 3-5-2</button>
        <button class="quick-action-btn" onclick="askQuickQuestion('Formazione 4-3-3 (600 crediti)')">âš½ Formazione 4-3-3</button>
        <button class="quick-action-btn" onclick="askQuickQuestion('Formazione 4-5-1 (450 crediti)')">âš½ Formazione 4-5-1</button>
        <button class="quick-action-btn" onclick="askQuickQuestion('Formazione 3-4-3 (550 crediti)')">âš½ Formazione 3-4-3</button>
        <button class="quick-action-btn" onclick="askQuickQuestion('2-3 difensori Under 21')">ğŸ‘¶ U21 Difensori</button>
        <button class="quick-action-btn" onclick="askQuickQuestion('3 centrocampisti Under 21')">ğŸ‘¶ U21 Centrocampisti</button>
        <button class="quick-action-btn" onclick="askQuickQuestion('2 attaccanti Under 21')">ğŸ‘¶ U21 Attaccanti</button>
        <button class="quick-action-btn" onclick="askQuickQuestion('Giovani Under 23 tutti i ruoli')">ğŸ‘¶ U23 Tutti i Ruoli</button>
        <button class="quick-action-btn" onclick="askQuickQuestion('Strategia per l\'asta')">ğŸ† Strategia Asta</button>
        <button class="quick-action-btn" onclick="askQuickQuestion('Ultimi acquisti Inter')">ğŸ“ˆ Acquisti Inter</button>
        <button class="quick-action-btn" onclick="askQuickQuestion('Ultimi acquisti Milan')">ğŸ“ˆ Acquisti Milan</button>
        <button class="quick-action-btn" onclick="askQuickQuestion('Ultimi acquisti Juventus')">ğŸ“ˆ Acquisti Juventus</button>
        <button class="quick-action-btn" onclick="askQuickQuestion('Ultimi acquisti Napoli')">ğŸ“ˆ Acquisti Napoli</button>
        <button class="quick-action-btn" onclick="askQuickQuestion('Ultimi acquisti Genoa')">ğŸ“ˆ Acquisti Genoa</button>
      </div>
    </div>

    <!-- Mantra -->
    <div class="tab-content" id="mantra">
      <div class="league-setup">
        <input type="number" id="participantsMantra" placeholder="{{ t.participants }}" value="8">
        <input type="number" id="budgetMantra" placeholder="{{ t.budget }}" value="500">
        <button class="btn btn-secondary" onclick="resetChat()">{{ t.reset_chat }}</button>
        <button class="btn btn-secondary" onclick="testAPI()" style="background: #dc3545;">ğŸ”§ Test API</button>
      </div>
      <div class="chat-container">
        <div class="chat-header">
          <div class="status-indicator"><span class="status-dot"></span><span>ModalitÃ  Mantra Attiva</span></div>
        </div>
        <div class="chat-messages" id="chatContainerMantra">
          <div class="message assistant-message">
            ğŸ‘‹ {{ t.welcome }}<br><br>ModalitÃ  <strong>Mantra</strong> attiva. Bonus assist e clean sheet attivi!
          </div>
        </div>
        <div class="typing-indicator" id="typingIndicatorMantra">
          <div class="typing-dots"><span></span><span></span><span></span></div>
          <span>L'assistente sta scrivendo...</span>
        </div>
        <div class="input-wrapper">
          <textarea id="messageInputMantra" placeholder="Scrivi la tua domanda..." maxlength="500" rows="3"></textarea>
          <button class="btn btn-primary" onclick="sendMessage('mantra')">{{ t.send }}</button>
        </div>
      </div>

      <div class="quick-actions">
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Migliori attaccanti per budget 150 crediti?')">ğŸ¯ Top Attaccanti Budget</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Top centrocampisti (budget 120)')">âš½ Top Centrocampisti</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Top difensori (budget 100)')">ğŸ›¡ï¸ Top Difensori</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Migliori portieri budget 40')">ğŸ¥… Top Portieri</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Formazione 3-5-2 con budget 500 crediti?')">âš½ Formazione 3-5-2</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Formazione 4-3-3 (600 crediti)')">âš½ Formazione 4-3-3</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Formazione 4-5-1 (450 crediti)')">âš½ Formazione 4-5-1</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Formazione 3-4-3 (550 crediti)')">âš½ Formazione 3-4-3</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('2-3 difensori Under 21')">ğŸ‘¶ U21 Difensori</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('3 centrocampisti Under 21')">ğŸ‘¶ U21 Centrocampisti</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('2 attaccanti Under 21')">ğŸ‘¶ U21 Attaccanti</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Giovani Under 23 tutti i ruoli')">ğŸ‘¶ U23 Tutti i Ruoli</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Strategia per l\'asta')">ğŸ† Strategia Asta</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Ultimi acquisti Inter')">ğŸ“ˆ Acquisti Inter</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Ultimi acquisti Milan')">ğŸ“ˆ Acquisti Milan</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Ultimi acquisti Juventus')">ğŸ“ˆ Acquisti Juventus</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Ultimi acquisti Napoli')">ğŸ“ˆ Acquisti Napoli</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Ultimi acquisti Roma')">ğŸ“ˆ Acquisti Roma</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Ultimi acquisti Lazio')">ğŸ“ˆ Acquisti Lazio</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Ultimi acquisti Atalanta')">ğŸ“ˆ Acquisti Atalanta</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Ultimi acquisti Fiorentina')">ğŸ“ˆ Acquisti Fiorentina</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Ultimi acquisti Bologna')">ğŸ“ˆ Acquisti Bologna</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Ultimi acquisti Torino')">ğŸ“ˆ Acquisti Torino</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Ultimi acquisti Udinese')">ğŸ“ˆ Acquisti Udinese</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Ultimi acquisti Monza')">ğŸ“ˆ Acquisti Monza</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Ultimi acquisti Empoli')">ğŸ“ˆ Acquisti Empoli</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Ultimi acquisti Lecce')">ğŸ“ˆ Acquisti Lecce</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Ultimi acquisti Cagliari')">ğŸ“ˆ Acquisti Cagliari</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Ultimi acquisti Parma')">ğŸ“ˆ Acquisti Parma</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Ultimi acquisti Como')">ğŸ“ˆ Acquisti Como</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Ultimi acquisti Venezia')">ğŸ“ˆ Acquisti Venezia</button>
        <button class="quick-action-btn" onclick="askQuickQuestionMantra('Ultimi acquisti Genoa')">ğŸ“ˆ Acquisti Genoa</button>
      </div>
    </div>

    <!-- Draft -->
    <div class="tab-content" id="draft">
      <div class="league-setup">
        <input type="number" id="participantsDraft" placeholder="{{ t.participants }}" value="8">
        <select id="draftOrder">
          <option value="snake">Snake Draft</option>
          <option value="linear">Linear Draft</option>
        </select>
        <button class="btn btn-secondary" onclick="resetChat()">{{ t.reset_chat }}</button>
        <button class="btn btn-secondary" onclick="testAPI()" style="background: #dc3545;">ğŸ”§ Test API</button>
      </div>
      <div class="chat-container">
        <div class="chat-header"><div class="status-indicator"><span class="status-dot"></span><span>ModalitÃ  Draft Attiva</span></div></div>
        <div class="chat-messages" id="chatContainerDraft">
          <div class="message assistant-message">ğŸ‘‹ {{ t.welcome }}<br><br>ModalitÃ  <strong>Draft</strong> attiva. Niente budget, solo strategia di selezione!</div>
        </div>
        <div class="typing-indicator" id="typingIndicatorDraft"><div class="typing-dots"><span></span><span></span><span></span></div><span>L'assistente sta scrivendo...</span></div>
        <div class="input-wrapper">
          <textarea id="messageInputDraft" placeholder="Scrivi la tua domanda..." maxlength="500" rows="3"></textarea>
          <button class="btn btn-primary" onclick="sendMessage('draft')">{{ t.send }}</button>
        </div>
      </div>

      <div class="quick-actions">
        <button class="quick-action-btn" onclick="askQuickQuestionDraft('Strategia draft Snake 8 partecipanti?')">ğŸ Snake Draft</button>
        <button class="quick-action-btn" onclick="askQuickQuestionDraft('Ordine di scelta per ruoli nel draft?')">ğŸ“‹ Ordine Ruoli</button>
        <button class="quick-action-btn" onclick="askQuickQuestionDraft('Migliori scelte primi turni draft?')">ğŸ¥‡ Prime Scelte</button>
        <button class="quick-action-btn" onclick="askQuickQuestionDraft('Sleeper picks per draft?')">ğŸ’ Sleeper Picks</button>
      </div>
    </div>

    <!-- Superscudetto -->
    <div class="tab-content" id="superscudetto">
      <div class="league-setup">
        <input type="number" id="participantsSuper" placeholder="{{ t.participants }}" value="8">
        <input type="number" id="budgetSuper" placeholder="{{ t.budget }}" value="500">
        <button class="btn btn-secondary" onclick="resetChat()">{{ t.reset_chat }}</button>
        <button class="btn btn-secondary" onclick="testAPI()" style="background: #dc3545;">ğŸ”§ Test API</button>
      </div>
      <div class="chat-container">
        <div class="chat-header"><div class="status-indicator"><span class="status-dot"></span><span>ModalitÃ  Superscudetto Attiva</span></div></div>
        <div class="chat-messages" id="chatContainerSuper">
          <div class="message assistant-message">ğŸ‘‹ {{ t.welcome }}<br><br>ModalitÃ  <strong>Superscudetto</strong> attiva. Regole speciali e premi aggiuntivi!</div>
        </div>
        <div class="typing-indicator" id="typingIndicatorSuper"><div class="typing-dots"><span></span><span></span><span></span></div><span>L'assistente sta scrivendo...</span></div>
        <div class="input-wrapper">
          <textarea id="messageInputSuper" placeholder="Scrivi la tua domanda..." maxlength="500" rows="3"></textarea>
          <button class="btn btn-primary" onclick="sendMessage('superscudetto')">{{ t.send }}</button>
        </div>
      </div>

      <div class="quick-actions">
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Migliori attaccanti per budget 150 crediti?')">ğŸ¯ Top Attaccanti Budget</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Top centrocampisti (budget 120)')">âš½ Top Centrocampisti</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Top difensori (budget 100)')">ğŸ›¡ï¸ Top Difensori</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Migliori portieri budget 40')">ğŸ¥… Top Portieri</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Formazione 3-5-2 con budget 500 crediti?')">âš½ Formazione 3-5-2</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Formazione 4-3-3 (600 crediti)')">âš½ Formazione 4-3-3</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Formazione 4-5-1 (450 crediti)')">âš½ Formazione 4-5-1</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Formazione 3-4-3 (550 crediti)')">âš½ Formazione 3-4-3</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('2-3 difensori Under 21')">ğŸ‘¶ U21 Difensori</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('3 centrocampisti Under 21')">ğŸ‘¶ U21 Centrocampisti</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('2 attaccanti Under 21')">ğŸ‘¶ U21 Attaccanti</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Giovani Under 23 tutti i ruoli')">ğŸ‘¶ U23 Tutti i Ruoli</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Strategia per l\'asta')">ğŸ† Strategia Asta</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Ultimi acquisti Inter')">ğŸ“ˆ Acquisti Inter</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Ultimi acquisti Milan')">ğŸ“ˆ Acquisti Milan</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Ultimi acquisti Juventus')">ğŸ“ˆ Acquisti Juventus</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Ultimi acquisti Napoli')">ğŸ“ˆ Acquisti Napoli</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Ultimi acquisti Roma')">ğŸ“ˆ Acquisti Roma</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Ultimi acquisti Lazio')">ğŸ“ˆ Acquisti Lazio</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Ultimi acquisti Atalanta')">ğŸ“ˆ Acquisti Atalanta</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Ultimi acquisti Fiorentina')">ğŸ“ˆ Acquisti Fiorentina</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Ultimi acquisti Bologna')">ğŸ“ˆ Acquisti Bologna</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Ultimi acquisti Torino')">ğŸ“ˆ Acquisti Torino</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Ultimi acquisti Udinese')">ğŸ“ˆ Acquisti Udinese</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Ultimi acquisti Monza')">ğŸ“ˆ Acquisti Monza</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Ultimi acquisti Empoli')">ğŸ“ˆ Acquisti Empoli</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Ultimi acquisti Lecce')">ğŸ“ˆ Acquisti Lecce</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Ultimi acquisti Cagliari')">ğŸ“ˆ Acquisti Cagliari</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Ultimi acquisti Parma')">ğŸ“ˆ Acquisti Parma</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Ultimi acquisti Como')">ğŸ“ˆ Acquisti Como</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Ultimi acquisti Venezia')">ğŸ“ˆ Acquisti Venezia</button>
        <button class="quick-action-btn" onclick="askQuickQuestionSuper('Ultimi acquisti Genoa')">ğŸ“ˆ Acquisti Genoa</button>
      </div>
    </div>

    <!-- Historical -->
    <div class="tab-content" id="historical">
      <div class="search-container">
        <div class="search-header">
          <input type="text" id="searchInput" placeholder="{{ t.search_placeholder }}" maxlength="100">
          <button onclick="performSearch()" class="btn btn-primary">ğŸ”</button>
        </div>
        <div class="filters">
          <select id="roleFilter" onchange="performSearch()">
            <option value="all">{{ t.all_roles }}</option>
            <option value="P">{{ t.goalkeeper }}</option>
            <option value="D">{{ t.defender }}</option>
            <option value="C">{{ t.midfielder }}</option>
            <option value="A">{{ t.forward }}</option>
          </select>
          <button onclick="downloadData()" class="filter-btn">ğŸ“Š Esporta Dati</button>
          <button onclick="exportLogs()" class="filter-btn">ğŸ“‹ Esporta Log</button>
          <button class="filter-btn" onclick="showAdvancedFilters()">ğŸ”§ Advanced</button>
        </div>
        <div id="searchResults" class="search-results">
          <div class="no-results"><p>Utilizza la ricerca per trovare statistiche di giocatori, squadre e campionati</p></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentTab='classic';

    function openModal(id){document.getElementById(id).classList.add('show')}
    function closeModal(id){document.getElementById(id).classList.remove('show')}
    function switchLang(lang){ location.href='/?lang='+lang }

    function switchTab(name, btn){
      // body class per tema contenuto
      document.body.classList.remove('mode-classic','mode-mantra','mode-draft','mode-superscudetto','mode-historical');
      document.body.classList.add('mode-'+name);

      // mostra contenuto
      document.querySelectorAll('.tab-content').forEach(c=>{c.classList.remove('active'); c.style.display='none';});
      const target=document.getElementById(name);
      if(target){ target.classList.add('active'); target.style.display='flex'; target.style.flexDirection='column'; }

      // attiva tab
      document.querySelectorAll('.tabs .tab').forEach(t=>t.classList.remove('active'));
      if(btn) btn.classList.add('active');

      currentTab=name;

      // scroll al tab su mobile
      const bar=document.querySelector('.tabs');
      if(bar && btn && bar.scrollTo){
        bar.scrollTo({left:btn.offsetLeft-40, behavior:'smooth'});
      }
    }

    // Chat functionality - complete implementation
    async function sendMessage(mode) {
        console.log('sendMessage called with mode:', mode);

        // Map mode to correct element IDs
        let inputId, containerId, typingId;

        switch(mode) {
            case 'classic':
                inputId = 'messageInput';
                containerId = 'chatContainer';
                typingId = 'typingIndicator';
                break;
            case 'mantra':
                inputId = 'messageInputMantra';
                containerId = 'chatContainerMantra';
                typingId = 'typingIndicatorMantra';
                break;
            case 'draft':
                inputId = 'messageInputDraft';
                containerId = 'chatContainerDraft';
                typingId = 'typingIndicatorDraft';
                break;
            case 'superscudetto':
                inputId = 'messageInputSuper';
                containerId = 'chatContainerSuper';
                typingId = 'typingIndicatorSuper';
                break;
            default:
                console.error('Unknown mode:', mode);
                return;
        }

        console.log('Using elements:', { inputId, containerId, typingId });

        const input = document.getElementById(inputId);
        const container = document.getElementById(containerId);
        const typing = document.getElementById(typingId);

        console.log('Elements found:', { input: !!input, container: !!container, typing: !!typing });

        if (!input || !container) {
            console.error('Required elements not found');
            return;
        }

        const message = input.value.trim();
        console.log('Message:', message);

        if (!message) {
            console.log('Empty message, returning');
            return;
        }

        // Add user message to chat
        const userMsg = document.createElement('div');
        userMsg.className = 'message user-message';
        userMsg.textContent = message;
        container.appendChild(userMsg);

        // Clear input
        input.value = '';

        // Show typing indicator
        if (typing) typing.style.display = 'flex';

        // Scroll to bottom
        container.scrollTop = container.scrollHeight;

        try {
            console.log('Sending request to /api/chat');
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message, mode })
            });

            console.log('Response status:', response.status);
            const data = await response.json();
            console.log('Response data:', data);

            // Hide typing indicator
            if (typing) typing.style.display = 'none';

            // Add assistant response
            const assistantMsg = document.createElement('div');
            assistantMsg.className = 'message assistant-message';
            assistantMsg.innerHTML = data.response || data.message || 'Risposta non disponibile';
            container.appendChild(assistantMsg);

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;

        } catch (error) {
            console.error('Error sending message:', error);

            // Hide typing indicator
            if (typing) typing.style.display = 'none';

            // Show error message
            const errorMsg = document.createElement('div');
            errorMsg.className = 'message assistant-message';
            errorMsg.innerHTML = 'âŒ Errore di connessione. Riprova piÃ¹ tardi.';
            container.appendChild(errorMsg);

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }
    }

    async function testAPI() {
        console.log('Testing API connection...');
        try {
            const response = await fetch('/api/test'); // Assuming a /api/test endpoint exists
            const data = await response.json();
            alert('API Test Successful: ' + JSON.stringify(data));
        } catch (error) {
            console.error('API Test Failed:', error);
            alert('API Test Failed. Check console for details.');
        }
    }

    function askQuickQuestion(q){ const i=document.getElementById('messageInput'); i.value=q; sendMessage('classic'); }
    function askQuickQuestionMantra(q){ const i=document.getElementById('messageInputMantra'); i.value=q; sendMessage('mantra'); }
    function askQuickQuestionDraft(q){ const i=document.getElementById('messageInputDraft'); i.value=q; sendMessage('draft'); }
    function askQuickQuestionSuper(q){ const i=document.getElementById('messageInputSuper'); i.value=q; sendMessage('superscudetto'); }
    function resetChat(){ fetch('/api/reset-chat',{method:'POST'}).catch(()=>{}); }

    function performSearch(){
      const q=document.getElementById('searchInput').value.trim();
      const role=document.getElementById('roleFilter').value;
      if(!q) return;
      fetch('/api/search',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query:q,role})})
        .then(r=>r.json())
        .then(data=>{
          const c=document.getElementById('searchResults');
          if(data.results && data.results.length){
            c.innerHTML = data.results.map(p=>`
              <div class="player-card">
                <div class="player-header">
                  <div class="player-name">${p.name}</div>
                  <div class="player-role">${p.role}</div>
                </div>
                <div class="player-details">
                  <div><strong>Squadra:</strong> ${p.team}</div>
                  <div><strong>Fantamedia:</strong> ${p.fantamedia}</div>
                  <div><strong>Presenze:</strong> ${p.appearances}</div>
                  <div><strong>Prezzo:</strong> ${p.price ?? 'N/A'}</div>
                </div>
              </div>`).join('');
          }else{
            c.innerHTML = `<div class="no-results"><p>Nessun risultato trovato.</p></div>`;
          }
        });
    }

    function downloadData(){ location.href='/api/export-logs'; } // placeholder

    function comparePlayersModal(){
      const p1=document.getElementById('player1Input').value.trim();
      const p2=document.getElementById('player2Input').value.trim();
      if(!p1||!p2){ alert('Inserisci entrambi i giocatori'); return; }
      const out=document.getElementById('comparisonResults');
      out.innerHTML='ğŸ”„ Caricamento...';
      fetch('/api/compare',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({players:[p1,p2]})})
        .then(r=>r.ok?r.json():r.json().then(e=>Promise.reject(e)))
        .then(d=>{
          if(!(d.comparison&&d.comparison.length)){ out.innerHTML='âŒ Giocatori non trovati'; return; }
          const a=d.comparison[0], b=d.comparison[1]||{};
          out.innerHTML = `
            <table class="comparison-table">
              <thead><tr class="comparison-header">
                <th class="comparison-metric">Metric</th>
                <th class="comparison-player">${a.name||'-'}</th>
                <th class="comparison-player">${b.name||'-'}</th>
              </tr></thead>
              <tbody>
                <tr class="comparison-row"><td class="comparison-metric">Squadra</td><td class="comparison-value">${a.team||'-'}</td><td class="comparison-value">${b.team||'-'}</td></tr>
                <tr class="comparison-row"><td class="comparison-metric">Fantamedia</td><td class="comparison-value">${a.fantamedia??'-'}</td><td class="comparison-value">${b.fantamedia??'-'}</td></tr>
                <tr class="comparison-row"><td class="comparison-metric">Prezzo</td><td class="comparison-value">${a.price??'-'}</td><td class="comparison-value">${b.price??'-'}</td></tr>
                <tr class="comparison-row"><td class="comparison-metric">Presenze</td><td class="comparison-value">${a.appearances??'-'}</td><td class="comparison-value">${b.appearances??'-'}</td></tr>
                <tr class="comparison-row"><td class="comparison-metric">Value Ratio</td><td class="comparison-value">${a.value_ratio??'-'}</td><td class="comparison-value">${b.value_ratio??'-'}</td></tr>
              </tbody>
            </table>
            <div class="comparison-summary"><h4>${d.metrics?.summary||'Confronto completato'}</h4></div>`;
        })
        .catch(err=>{ out.innerHTML = `âŒ Errore: ${err.error||'imprevisto'}`; });
    }

    // Add Enter key support for all message inputs
    function addEnterKeySupport() {
        const inputs = ['messageInput', 'messageInputMantra', 'messageInputDraft', 'messageInputSuper'];
        inputs.forEach((inputId, index) => {
            const input = document.getElementById(inputId);
            if (input) {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        const modes = ['classic', 'mantra', 'draft', 'superscudetto'];
                        sendMessage(modes[index]);
                    }
                });
            }
        });
    }

    // Add Enter key support for historical search input
    document.getElementById('searchInput')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        performSearch();
      }
    });


    // Start-up: Classic mode by default
    document.addEventListener('DOMContentLoaded', ()=>{
      const firstTab=document.querySelector('.tabs .tab');
      switchTab('classic', firstTab);
      addEnterKeySupport();
    });

    // Close modals by clicking outside
    window.addEventListener('click',e=>{
      if(e.target.classList.contains('modal')) e.target.classList.remove('show');
    });

    // Historical stats specific functions
    function showHistoricalStats(){
      const modal = document.getElementById('historicalModal'); // This modal is not defined in the HTML, assuming it's meant to be the 'historical' tab content
      // The 'historical' tab content is directly shown by switchTab, no modal needed here.
      // Load initial data when the tab is activated.
      loadTopPerformers();
    }
    // Renamed closeHistoricalModal to just be part of the tab switching logic

    async function loadTopPerformers() {
      const out = document.getElementById('searchResults'); // Changed from historicalResults to searchResults to match the HTML
      out.innerHTML = '<div class="loading">ğŸ”„ Caricamento statistiche...</div>';

      try {
        // Load all players to show top performers by category
        const response = await fetch('/api/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: '', role: '' }) // Fetch all players for overview
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error);

        const players = data.results || [];
        if (players.length === 0) {
          out.innerHTML = '<p>Nessun dato disponibile</p>';
          return;
        }

        // Sort and categorize players
        const topPerformers = players.sort((a, b) => b.fantamedia - a.fantamedia).slice(0, 10);
        const bestValue = players.sort((a, b) => {
          const ratioA = a.fantamedia / Math.max(a.price, 1);
          const ratioB = b.fantamedia / Math.max(b.price, 1);
          return ratioB - ratioA;
        }).slice(0, 10);

        // Group by role
        const byRole = {};
        players.forEach(p => {
          if (!byRole[p.role]) byRole[p.role] = [];
          byRole[p.role].push(p);
        });

        let html = `
          <div class="stats-overview">
            <h3>ğŸ“Š Panoramica Generale</h3>
            <div class="stats-summary">
              <div class="stat-item">
                <strong>Giocatori totali:</strong> ${players.length}
              </div>
              <div class="stat-item">
                <strong>Fantamedia media:</strong> ${(players.reduce((sum, p) => sum + p.fantamedia, 0) / players.length).toFixed(2)}
              </div>
              <div class="stat-item">
                <strong>Prezzo medio:</strong> ${(players.reduce((sum, p) => sum + p.price, 0) / players.length).toFixed(1)} crediti
              </div>
            </div>
          </div>

          <div class="stats-tabs">
            <button class="stats-tab active" onclick="showStatsTab('top')">ğŸ† Top Performers</button>
            <button class="stats-tab" onclick="showStatsTab('value')">ğŸ’° Miglior Rapporto Q/P</button>
            <button class="stats-tab" onclick="showStatsTab('roles')">ğŸ‘¥ Per Ruolo</button>
          </div>

          <div id="stats-top" class="stats-content active">
            <h4>ğŸ† Migliori per Fantamedia</h4>
            <div class="results-grid">
        `;

        topPerformers.forEach((player, index) => {
          const valueRatio = ((player.fantamedia / Math.max(player.price, 1)) * 100).toFixed(1);
          html += `
            <div class="player-card top-performer">
              <div class="rank">#${index + 1}</div>
              <h4>${player.name}</h4>
              <p><strong>Squadra:</strong> ${player.team}</p>
              <p><strong>Ruolo:</strong> ${getRoleLabel(player.role)}</p>
              <p><strong>Fantamedia:</strong> <span class="highlight">${player.fantamedia}</span></p>
              <p><strong>Prezzo:</strong> ${player.price} crediti</p>
              <p><strong>Presenze:</strong> ${player.appearances}</p>
              <p><strong>Rapporto Q/P:</strong> ${valueRatio}%</p>
            </div>
          `;
        });

        html += `
            </div>
          </div>

          <div id="stats-value" class="stats-content">
            <h4>ğŸ’° Miglior Rapporto QualitÃ /Prezzo</h4>
            <div class="results-grid">
        `;

        bestValue.forEach((player, index) => {
          const valueRatio = ((player.fantamedia / Math.max(player.price, 1)) * 100).toFixed(1);
          html += `
            <div class="player-card best-value">
              <div class="rank">#${index + 1}</div>
              <h4>${player.name}</h4>
              <p><strong>Squadra:</strong> ${player.team}</p>
              <p><strong>Ruolo:</strong> ${getRoleLabel(player.role)}</p>
              <p><strong>Fantamedia:</strong> ${player.fantamedia}</p>
              <p><strong>Prezzo:</strong> ${player.price} crediti</p>
              <p><strong>Rapporto Q/P:</strong> <span class="highlight">${valueRatio}%</span></p>
            </div>
          `;
        });

        html += `
            </div>
          </div>

          <div id="stats-roles" class="stats-content">
            <h4>ğŸ‘¥ Statistiche per Ruolo</h4>
        `;

        Object.keys(byRole).sort().forEach(role => {
          const rolePlayers = byRole[role];
          const avgFantamedia = (rolePlayers.reduce((sum, p) => sum + p.fantamedia, 0) / rolePlayers.length).toFixed(2);
          const avgPrice = (rolePlayers.reduce((sum, p) => sum + p.price, 0) / rolePlayers.length).toFixed(1);
          const topInRole = rolePlayers.sort((a, b) => b.fantamedia - a.fantamedia).slice(0, 3);

          html += `
            <div class="role-stats">
              <h5>${getRoleLabel(role)} (${rolePlayers.length} giocatori)</h5>
              <div class="role-summary">
                <span>Media fantamedia: ${avgFantamedia}</span>
                <span>Prezzo medio: ${avgPrice} crediti</span>
              </div>
              <div class="role-top">
                <strong>Top 3:</strong>
                ${topInRole.map(p => `${p.name} (${p.fantamedia})`).join(', ')}
              </div>
            </div>
          `;
        });

        html += `
          </div>
        `;

        out.innerHTML = html;
      } catch (err) {
        out.innerHTML = `âŒ Errore nel caricamento delle statistiche: ${err.message}`;
      }
    }

    function getRoleLabel(role) {
      const labels = { 'P': 'Portiere', 'D': 'Difensore', 'C': 'Centrocampista', 'A': 'Attaccante' };
      return labels[role] || role;
    }

    function showStatsTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.stats-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.stats-tab').forEach(btn => btn.classList.remove('active'));

      // Show selected tab
      document.getElementById(`stats-${tabName}`).classList.add('active');
      event.target.classList.add('active');
    }

    async function searchHistoricalData(){
      const query = document.getElementById('searchInput').value.trim();
      const role = document.getElementById('roleFilter').value;
      const out = document.getElementById('searchResults'); // Changed from historicalResults to searchResults

      if (!query) {
        loadTopPerformers(); // If search query is empty, show top performers
        return;
      }

      out.innerHTML = '<div class="loading">ğŸ”„ Ricerca in corso...</div>';

      try {
        const response = await fetch('/api/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query, role })
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error);

        const results = data.results || [];
        if (results.length === 0) {
          out.innerHTML = '<p>Nessun risultato trovato per la ricerca</p>';
          return;
        }

        let html = `
          <div class="search-results">
            <h4>ğŸ” Risultati per: "${query}" ${role && role !== 'all' ? `(${getRoleLabel(role)})` : ''}</h4>
            <div class="results-grid">
        `;

        results.forEach(player => {
          const valueRatio = ((player.fantamedia / Math.max(player.price, 1)) * 100).toFixed(1);
          html += `
            <div class="player-card">
              <h4>${player.name}</h4>
              <p><strong>Squadra:</strong> ${player.team}</p>
              <p><strong>Ruolo:</strong> ${getRoleLabel(player.role)}</p>
              <p><strong>Fantamedia:</strong> ${player.fantamedia}</p>
              <p><strong>Prezzo:</strong> ${player.price} crediti</p>
              <p><strong>Presenze:</strong> ${player.appearances}</p>
              <p><strong>Rapporto Q/P:</strong> ${valueRatio}%</p>
            </div>
          `;
        });

        html += `
            </div>
            <button onclick="loadTopPerformers()" class="btn-secondary" style="margin-top: 20px;">
              â† Torna alle statistiche generali
            </button>
          </div>
        `;

        out.innerHTML = html;
      } catch (err) {
        out.innerHTML = `âŒ Errore: ${err.message}`;
      }
    }

    // Ensure the historical tab's search input has event listener
    document.addEventListener('DOMContentLoaded', () => {
        // ... other initializations ...
        const historicalSearchInput = document.getElementById('searchInput');
        if (historicalSearchInput) {
            historicalSearchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    performSearch();
                }
            });
        }

        // Also set the initial tab correctly
        const firstTab = document.querySelector('.tabs .tab');
        switchTab('classic', firstTab);
        addEnterKeySupport();
    });

  </script>
</body>
</html>